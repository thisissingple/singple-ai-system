import 'dotenv/config';
import { createPool, queryDatabase } from '../server/services/pg-client';
import OpenAI from 'openai';

const TEACHING_QUALITY_ANALYSIS_PROMPT = `ä½ æ˜¯ä¸€ä½å°ˆç²¾éŠ·å”®èˆ‡æ•™å­¸å ´æ™¯çš„ç­–ç•¥æ•™ç·´ã€‚
è«‹é–±è®€é€å­—ç¨¿å¾Œï¼Œè¼¸å‡ºå¯ç›´æ¥æ‹¿ä¾†æˆäº¤èˆ‡è¿½è¹¤çš„åˆ†æã€‚è¼¸å‡ºæ ¼å¼è«‹ç”¨ Markdownï¼ˆæ¨™é¡Œã€ç²—é«”ã€é …ç›®ç¬¦è™Ÿå®Œå…¨ä¾ä¸‹åˆ—æ¨¡æ¿ï¼‰ï¼Œä¸å¯èª¿æ•´æ®µè½æˆ–éºæ¼ã€‚è‹¥æ‰¾ä¸åˆ°è³‡è¨Šï¼š
1. åœ¨ã€Œä»éœ€è£œå•ã€æ®µè½åˆ—å‡ºç¼ºæ¼é …ç›®ã€‚
2. åŒæ™‚åœ¨å°æ‡‰æ¬„ä½ä»¥ã€Œéœ€è£œå•ï¼š...ï¼ˆåŸå› ï¼‰ã€å¡«å…¥æé†’æ–‡å­—ã€‚
æ¯å€‹æ•˜è¿°éƒ½è¦å¸¶ä¸Šé€å­—ç¨¿çš„æ™‚é–“æˆ³æˆ–å¼•ç”¨ç‰‡æ®µï¼ˆä¾‹å¦‚ï¼š00:12:34ï¼‰ã€‚

---

# ğŸ§‘â€ğŸ« å­¸å“¡ç‹€æ³æŒæ¡ï¼ˆå¿«é€ŸæŒæ¡å°è±¡ï¼‰

- **ğŸ“‡ åŸºæœ¬è³‡æ–™ï¼ˆèº«ä»½é€Ÿå¯«ï¼‰**
  - å¹´é½¡ï¼æ€§åˆ¥ï¼è·æ¥­ï¼è§’è‰²ï¼š{{ studentProfile }}
  - æ˜¯å¦è‡ªå·±æ±ºå®šæ˜¯å¦è³¼èª²ï¼š{{ æ±ºç­–è³‡è¨Šï¼ˆå¯å¾ studentProfile è£œå……ï¼‰ }}
  - åƒ¹æ ¼æ•æ„Ÿåº¦ï¼ä»˜è²»èƒ½åŠ›ï¼š{{ studentProfile ä¸­çš„åƒ¹æ ¼æ…‹åº¦æè¿° }}

---

- **ğŸ¤ è²éŸ³ç¾æ³ï¼ˆç›®å‰è²éŸ³ç‹€æ…‹ï¼‰**
  {{ currentStatus.currentSkillState }}

- **ğŸ“š éå»å˜—è©¦éçš„æ–¹æ³•æˆ–èª²ç¨‹**
  {{ currentStatus.pastAttempts[0] }}
  {{ currentStatus.pastAttempts[1] }}

- **â›”ï¸ ç¾åœ¨æœ€å¡çš„åœ°æ–¹**
  {{ currentStatus.currentBlocks[0] }}
  {{ currentStatus.currentBlocks[1] }}

- **ğŸ æƒ³æˆç‚ºä»€éº¼æ¨£çš„è‡ªå·±ï¼ˆç›®æ¨™ç•«é¢ï¼‰**
  {{ currentStatus.desiredOutcome }}

- **ğŸ¯ ç‚ºä»€éº¼ç¾åœ¨ç‰¹åˆ¥æƒ³å­¸ï¼Ÿï¼ˆç•¶ä¸‹å‹•æ©Ÿï¼‰**
  {{ currentStatus.motivation }}

- **ğŸ¬ æƒ³æŠŠè²éŸ³ç”¨åœ¨å“ªè£¡ï¼Ÿï¼ˆæ‡‰ç”¨å ´æ™¯ï¼‰**
  {{ currentStatus.intendedUsage }}

- **ğŸ“ ä»éœ€è£œå•**
  {{ missingData é …ç›®ï¼›è‹¥ç„¡ç¼ºæ¼è«‹å¯«ã€Œç„¡ã€ }}


# ğŸ§® æˆäº¤ç­–ç•¥è©•ä¼°ï¼ˆæŒ‡æ¨™åˆ¶ï¼‰
- å‘¼æ‡‰ç—›é»ç¨‹åº¦ï¼š{{ scorePain }}/5ï¼ˆè­‰æ“šï¼š{{ ç—›é»ä½è­‰èˆ‡æ™‚é–“æˆ³ }}ï¼‰
- æ¨èª²å¼•å°åŠ›åº¦ï¼š{{ scorePitch }}/5ï¼ˆè­‰æ“šï¼š{{ æ¨èª²ç‰‡æ®µèˆ‡æ™‚é–“æˆ³ }}ï¼‰
- Double Bind / NLP æ‡‰ç”¨ï¼š{{ scorePsych }}/5ï¼ˆè­‰æ“šï¼š{{ æŠ€å·§å¼•ç”¨èˆ‡æ™‚é–“æˆ³ }}ï¼‰
- æƒ…ç·’å…±é³´èˆ‡ä¿¡ä»»ï¼š{{ scoreEmotion }}/5ï¼ˆè­‰æ“šï¼š{{ å…±æ„Ÿç‰‡æ®µèˆ‡æ™‚é–“æˆ³ }}ï¼‰
- ç¯€å¥èˆ‡æ”¶æ–‚å®Œæ•´åº¦ï¼š{{ scoreFlow }}/5ï¼ˆèªªæ˜ï¼š{{ ç¯€å¥è©•è«– }}ï¼‰
- **ç¸½è©•**ï¼š{{ ç¸½çµè©•è«–ï¼ˆå«ç›®å‰æœ€æœ‰åŠ›ï¼éœ€è£œå¼·çš„é‡é»ï¼‰ }}

---

# ğŸš€ ä¸‹ä¸€æ¬¡æˆäº¤ç­–ç•¥å»ºè­°ï¼ˆæ”»æ“Šæ–¹å‘ï¼‰
- {{ å»ºè­°æ–¹å‘1ï¼ˆå°æ‡‰ç‰¹å®šç—›é»æˆ–ç“¶é ¸ï¼Œå«æ™‚é–“æˆ³ï¼‰ }}
- {{ å»ºè­°æ–¹å‘2ï¼ˆå¯åŠ å…¥æ•…äº‹ã€æ¡ˆä¾‹æˆ–ç¤¾æœƒè­‰æ˜çš„åˆ‡è§’ï¼‰ }}
- {{ å»ºè­°æ–¹å‘3ï¼ˆéœ€è£œå¼·çš„æ•¸æ“šï¼æ•™æï¼è­‰æ“šï¼‰ }}

---

# ğŸ’¬ å®Œæ•´æˆäº¤è©±è¡“ç¸½çµï¼ˆå¯ç…§å¿µï¼‰

1. **ç‰ˆæœ¬ A â€” Bateson èª˜å° + Double Bind + åƒ¹å€¼é‡æ§‹**
   > {{ ç‰ˆæœ¬Aè©±è¡“ï¼ˆ360-420 å­—ï¼Œé–‹é ­å…ˆä»¥å£èªåŒ–èªæ°£å…±æ„Ÿã€Œç—›é»ã€ï¼Œä¸­æ®µå¼•ç”¨è‡³å°‘å…©å€‹ã€Œå¡é—œç´°ç¯€ã€èˆ‡ä¸€å€‹ã€Œå¤¢æƒ³ç•«é¢ã€ä¸¦æ¨™ç¤ºæ™‚é–“æˆ³ï¼Œç©¿æ’å…©å¥ä»¥ä¸Šè²ç‰¹æ£®éšå±¤æå•ï¼Œå¼•å°å­¸å“¡é‡æ–°å®šç¾©åƒ¹å€¼ï¼›å…§æ–‡éœ€è‡³å°‘ 12 å¥ï¼Œä¸¦åŒ…å«ä¸‹åˆ—æ„Ÿå®˜å°æ®µï¼š\\n   - ã€è¦–è¦ºã€‘...\\n   - ã€è½è¦ºã€‘...\\n   - ã€å‹•è¦ºã€‘...\\n è‹¥ç¼ºè³‡è¨Šé ˆä»¥ã€Œéœ€è£œå•ã€è£œè¶³ï¼›çµå°¾åŠ å…¥ï¼š\\n   - é¸æ“‡ Aï¼š{{ æ­£å‘é¸é … A }}\\n   - é¸æ“‡ Bï¼š{{ æ­£å‘é¸é … B }}\\n ä¸¦é™„æ˜ç¢ºè¡Œå‹•é‚€è«‹ã€‚ï¼‰ }}

2. **ç‰ˆæœ¬ B â€” æƒ…ç·’å…±é³´ + æå¤±è¦é¿ + Double Bind**
   > {{ ç‰ˆæœ¬Bè©±è¡“ï¼ˆ360-420 å­—ï¼Œå¾æƒ…ç·’å…±é³´åˆ‡å…¥ä¸¦å¼•ç”¨æ ¸å¿ƒç—›é»èˆ‡å¤¢æƒ³æ®µè½ï¼ˆé™„æ™‚é–“æˆ³ï¼‰ï¼Œæç¹ªè‹¥ä¸æ”¹è®Šå°‡å¸¶ä¾†çš„æå¤±ï¼›å…¨æ–‡éœ€è‡³å°‘ 12 å¥ä¸¦åŒ…å«æ„Ÿå®˜å°æ®µï¼š\\n   - ã€è¦–è¦ºã€‘...\\n   - ã€è½è¦ºã€‘...\\n   - ã€å‹•è¦ºã€‘...\\n è‹¥è³‡æ–™ä¸è¶³æ”¹å¯«ç‚ºã€Œéœ€è£œå•ã€ã€‚çµå°¾åŠ å…¥é›™é‡æŸç¸›æ¢åˆ—ï¼š\\n   - é¸æ“‡ Aï¼š{{ æ­£å‘é¸é … A }}\\n   - é¸æ“‡ Bï¼š{{ æ­£å‘é¸é … B }}\\n ä¸¦é‡ç”³ç«‹å³è¡Œå‹•çš„ç†ç”±ã€‚ï¼‰ }}

3. **ç‰ˆæœ¬ C â€” æœªä¾†è‡ªæˆ‘å®šä½ + NLP éŒ¨å®š + è¡Œå‹•æ‰¿è«¾**
   > {{ ç‰ˆæœ¬Cè©±è¡“ï¼ˆ360-420 å­—ï¼Œé€éæœªä¾†è‡ªæˆ‘å®šä½èˆ‡ NLP éŒ¨å®šæŒ‡ä»¤ï¼Œå¼•å°å­¸å“¡æ„Ÿå—æˆåŠŸå ´æ™¯ï¼Œå¼•ç”¨è‡³å°‘ä¸‰å€‹å…·é«”è­‰æ“šèˆ‡æ™‚é–“æˆ³ï¼›å…¨æ–‡éœ€è‡³å°‘ 12 å¥ä¸¦åŒ…å«ï¼š\\n   - ã€è¦–è¦ºã€‘...\\n   - ã€è½è¦ºã€‘...\\n   - ã€å‹•è¦ºã€‘...\\n è‹¥è³‡æ–™ä¸è¶³ä»¥ã€Œéœ€è£œå•ã€è£œè¶³ã€‚çµå°¾ä»¥æ¢åˆ—å‘ˆç¾é›™é‡æŸç¸›ï¼š\\n   - é¸æ“‡ Aï¼š{{ æ­£å‘é¸é … A }}\\n   - é¸æ“‡ Bï¼š{{ æ­£å‘é¸é … B }}\\n ä¸¦é‚€è«‹å­¸å“¡åšå‡ºå…·é«”æ‰¿è«¾ã€‚ï¼‰ }}

---

# ğŸ“ˆ é ä¼°æˆäº¤æ©Ÿç‡ï¼š{{ conversionProbability }}%
- **è©•ä¼°ä¾æ“šï¼š**
  - æˆå“¡åé¥‹ï¼é—œéµå°è©±è­‰æ“šï¼š{{ å«æ™‚é–“æˆ³çš„ä½è­‰é‡é» }}
  - æŠ€è¡“æ”¹å–„ç©ºé–“ï¼š{{ æŠ€è¡“é¢è©•ä¼° }}
  - å¿ƒç†é˜»åŠ›ç¨‹åº¦ï¼š{{ å¿ƒç†é¢è©•ä¼° }}

---

## å¯«ä½œåŸå‰‡
- å…§å®¹è¦å£èªã€å‹™å¯¦ï¼Œå¯ä»¥ç›´æ¥å¿µå‡ºä¾†ã€‚
- ä¿ç•™æ‰€æœ‰ emojiã€æ¨™é¡Œèˆ‡æ®µè½é †åºã€‚
- ç¼ºè³‡æ–™å°±åŒæ™‚åœ¨ã€Œä»éœ€è£œå•ã€åˆ—å‡ºï¼Œä¸¦åœ¨åŸæ¬„ä½å¡«ã€Œéœ€è£œå•ï¼š...ï¼ˆåŸå› ï¼‰ã€ã€‚
- ä¸‰å€‹æˆäº¤ç‰ˆæœ¬å¿…é ˆæ˜é¡¯å€éš”ï¼ˆåƒ¹å€¼é‡æ§‹ï¼æå¤±è¦é¿ï¼æœªä¾†è‡ªæˆ‘ï¼‰ï¼Œæ¯æ®µå­—æ•¸éœ€è½åœ¨ 360-420 å­—ã€‚
- æ¯å€‹ç‰ˆæœ¬éœ€åµŒå…¥è²ç‰¹æ£®æå•æˆ– NLP æŠ€å·§ï¼Œä¸¦åœ¨å…§æ–‡ä»¥æ¢åˆ—å½¢å¼æ˜ç¢ºä½¿ç”¨ã€è¦–è¦ºã€‘ã€ã€è½è¦ºã€‘ã€ã€å‹•è¦ºã€‘æ¨™ç±¤æè¿°æ„Ÿå®˜ç•«é¢ï¼ˆç¼ºè³‡è¨Šæ™‚ä»¥è‡ªç„¶èªæ°£è£œå¯«ã€Œéœ€è£œå•ã€ï¼‰ã€‚
- çµå°¾çš„é›™é‡æŸç¸›éœ€ä»¥æ¢åˆ—å½¢å¼å‘ˆç¾å…©å€‹å…·é«”æ­£å‘é¸é …ï¼ˆæ ¼å¼å¿…é ˆç‚ºã€Œ- é¸æ“‡ Aï¼š...ã€ã€Œ- é¸æ“‡ Bï¼š...ã€ï¼‰ã€‚
- æˆäº¤æ©Ÿç‡éœ€åˆ—å‡º 2-3 å€‹å…·æ™‚é–“æˆ³çš„è©•ä¼°ä¾æ“šï¼Œèªªæ˜åˆ†æ•¸ä¾†æºã€‚

---

**è¼¸å‡ºæ ¼å¼**ï¼šåªè¼¸å‡ºä¸Šè¿° Markdown å…§å®¹ï¼Œä¸è¦å…¶ä»–æ–‡å­—ã€‚`;

async function fixChenWithCorrectPrompt() {
  const pool = createPool();
  const analysisId = 'fb1dbdd0-283b-4a04-b8fd-b3e944375660';

  console.log('\nğŸ”§ ä½¿ç”¨æ­£ç¢ºçš„ Markdown prompt é‡æ–°ç”Ÿæˆé™³å† éœ–çš„æ¨èª²åˆ†æ...\n');

  try {
    // 1. å–å¾—åˆ†æè¨˜éŒ„
    const analysisResult = await queryDatabase(`
      SELECT
        id,
        student_name,
        teacher_name,
        transcript_text
      FROM teaching_quality_analysis
      WHERE id = $1
    `, [analysisId]);

    if (analysisResult.rows.length === 0) {
      console.error('âŒ æ‰¾ä¸åˆ°åˆ†æè¨˜éŒ„');
      return;
    }

    const analysis = analysisResult.rows[0];
    console.log('âœ… æ‰¾åˆ°åˆ†æè¨˜éŒ„');
    console.log('  - å­¸å“¡:', analysis.student_name);
    console.log('  - æ•™å¸«:', analysis.teacher_name);
    console.log('  - é€å­—ç¨¿é•·åº¦:', analysis.transcript_text?.length || 0);

    if (!analysis.transcript_text) {
      console.error('âŒ æ²’æœ‰é€å­—ç¨¿');
      return;
    }

    // 2. å‘¼å« OpenAI API
    console.log('\nğŸ“ å‘¼å« OpenAI APIï¼ˆä½¿ç”¨ Markdown promptï¼‰...');

    const openai = new OpenAI({
      apiKey: process.env.OPENAI_API_KEY,
    });

    const userMessage = `ğŸ“¥ å­¸å“¡å°è©±ç´€éŒ„ï¼š

**å­¸å“¡å§“å**: ${analysis.student_name}
**è«®è©¢å¸«/æ•™å¸«**: ${analysis.teacher_name}
**èª²ç¨‹ä¸»é¡Œ**: é«”é©—èª²

**å®Œæ•´å°è©±è¨˜éŒ„**:
${analysis.transcript_text}

---

è«‹ä¾ç…§ç³»çµ±æç¤ºä¸­çš„ Markdown æ¨¡æ¿ï¼Œç”Ÿæˆå®Œæ•´çš„éŠ·å”®åˆ†æå ±å‘Šã€‚å‹™å¿…ï¼š
- ä¿ç•™æ‰€æœ‰æ¨™é¡Œã€åˆ†éš”ç·šèˆ‡ emojiã€‚
- é‡å°æ¯å€‹æ¬„ä½å¡«å…¥å…·é«”å…§å®¹ï¼Œç¼ºè³‡æ–™æ™‚ä½¿ç”¨ã€Œéœ€è£œå•ï¼š...ã€ä¸¦åŒæ­¥åˆ—å…¥ã€Œä»éœ€è£œå•ã€æ¸…å–®ã€‚
- æ¯å€‹è§€å¯Ÿèˆ‡è©±è¡“éƒ½åŠ ä¸Šé€å­—ç¨¿æ™‚é–“æˆ³ï¼ˆä¾‹å¦‚ï¼š00:12:34ï¼‰æˆ–å¼•ç”¨ç‰‡æ®µã€‚
- æœ€å¾Œä¸€æ®µéœ€åŒ…å«å…©å€‹ double bind è¡Œå‹•é¸é …èˆ‡æˆäº¤æ©Ÿç‡ã€‚`;

    const completion = await openai.chat.completions.create({
      model: 'gpt-4o',
      messages: [
        { role: 'system', content: TEACHING_QUALITY_ANALYSIS_PROMPT },
        { role: 'user', content: userMessage }
      ],
      temperature: 0.7
    });

    const markdownOutput = completion.choices[0].message.content;

    if (!markdownOutput) {
      console.error('âŒ OpenAI å›æ‡‰ç‚ºç©º');
      return;
    }

    console.log('âœ… OpenAI å›æ‡‰æˆåŠŸ');
    console.log('  - Markdown é•·åº¦:', markdownOutput.length);

    // 3. å¾ markdown ä¸­æå–æˆäº¤æ©Ÿç‡
    const probabilityMatch = markdownOutput.match(/é ä¼°æˆäº¤æ©Ÿç‡[ï¼š:]\s*(\d+)%/);
    const conversionProbability = probabilityMatch ? parseInt(probabilityMatch[1], 10) : 70;

    // 4. æ›´æ–°è³‡æ–™åº«ï¼ˆä½¿ç”¨æ­£ç¢ºçš„æ ¼å¼ï¼šmarkdownOutput + conversionProbabilityï¼‰
    const conversionSuggestions = {
      markdownOutput,
      conversionProbability
    };

    await queryDatabase(`
      UPDATE teaching_quality_analysis
      SET conversion_suggestions = $1,
          updated_at = NOW()
      WHERE id = $2
    `, [JSON.stringify(conversionSuggestions), analysisId]);

    console.log('\nâœ… æ¨èª²åˆ†æå·²æ›´æ–°åˆ°è³‡æ–™åº«ï¼');
    console.log('  - æˆäº¤æ©Ÿç‡:', conversionProbability, '%');
    console.log('\nğŸ“ ç”Ÿæˆçš„æ¨èª²åˆ†æé è¦½ï¼ˆå‰ 1000 å­—å…ƒï¼‰:');
    console.log(markdownOutput.substring(0, 1000));
    console.log('\n...\n');

  } catch (error) {
    console.error('âŒ éŒ¯èª¤:', error);
  } finally {
    await pool.end();
  }
}

fixChenWithCorrectPrompt();
