/**
 * Supabase Migration Verification Script
 * é©—è­‰æ‰€æœ‰è³‡æ–™å·²å¾ Neon é·ç§»åˆ° Supabase
 */

import { getSupabaseClient, isSupabaseAvailable, testSupabaseConnection } from '../server/services/supabase-client';
import { storage } from '../server/storage';

async function verify() {
  console.log('ğŸ” é–‹å§‹é©—è­‰ Supabase é·ç§»ç‹€æ…‹...\n');

  const results = {
    passed: [] as string[],
    failed: [] as string[],
    warnings: [] as string[],
  };

  // 1. æª¢æŸ¥ Supabase Client åˆå§‹åŒ–
  console.log('1ï¸âƒ£  æª¢æŸ¥ Supabase Client...');
  if (isSupabaseAvailable()) {
    results.passed.push('âœ… Supabase client å·²æˆåŠŸåˆå§‹åŒ–');
  } else {
    results.failed.push('âŒ Supabase client åˆå§‹åŒ–å¤±æ•—');
    console.log('\nâŒ éŒ¯èª¤ï¼šè«‹æª¢æŸ¥ .env æª”æ¡ˆä¸­çš„ SUPABASE_URL å’Œ SUPABASE_SERVICE_ROLE_KEY');
    return;
  }

  // 2. æ¸¬è©¦ Supabase é€£ç·š
  console.log('2ï¸âƒ£  æ¸¬è©¦ Supabase é€£ç·š...');
  const connectionTest = await testSupabaseConnection();
  if (connectionTest.success) {
    results.passed.push('âœ… Supabase é€£ç·šæ¸¬è©¦æˆåŠŸ');
  } else {
    results.failed.push(`âŒ Supabase é€£ç·šå¤±æ•—: ${connectionTest.error}`);
  }

  // 3. æª¢æŸ¥å¿…è¦çš„ tables æ˜¯å¦å­˜åœ¨
  console.log('3ï¸âƒ£  æª¢æŸ¥è³‡æ–™è¡¨çµæ§‹...');
  const client = getSupabaseClient();
  if (!client) {
    results.failed.push('âŒ ç„¡æ³•å–å¾— Supabase client');
    return;
  }

  const requiredTables = [
    'users',
    'sessions',
    'roles',
    'spreadsheets',
    'worksheets',
    'sheet_data',
    'google_oauth_tokens',
    'sync_history',
    'trial_class_attendance',
    'trial_class_purchase',
    'eods_for_closers',
  ];

  for (const table of requiredTables) {
    try {
      const { error } = await client.from(table).select('id').limit(1);
      if (error) {
        results.failed.push(`âŒ è³‡æ–™è¡¨ ${table} ä¸å­˜åœ¨æˆ–ç„¡æ³•è¨ªå•`);
      } else {
        results.passed.push(`âœ… è³‡æ–™è¡¨ ${table} å­˜åœ¨`);
      }
    } catch (e) {
      results.failed.push(`âŒ è³‡æ–™è¡¨ ${table} æª¢æŸ¥å¤±æ•—: ${e}`);
    }
  }

  // 4. æ¸¬è©¦ Storage ä»‹é¢
  console.log('4ï¸âƒ£  æ¸¬è©¦ Storage ä»‹é¢...');
  try {
    // Test listSpreadsheets
    const spreadsheets = await storage.listSpreadsheets();
    results.passed.push(`âœ… Storage.listSpreadsheets() æˆåŠŸ (${spreadsheets.length} å€‹ spreadsheets)`);

    // Test getUser (should work even if no users exist)
    try {
      const user = await storage.getUser('test-id');
      results.passed.push('âœ… Storage.getUser() å¯æ­£å¸¸å‘¼å«');
    } catch (e: any) {
      if (e.message.includes('not available')) {
        results.failed.push('âŒ Storage å°šæœªé€£æ¥åˆ° Supabase');
      } else {
        results.passed.push('âœ… Storage.getUser() å¯æ­£å¸¸å‘¼å«');
      }
    }

  } catch (e) {
    results.failed.push(`âŒ Storage ä»‹é¢æ¸¬è©¦å¤±æ•—: ${e}`);
  }

  // 5. æª¢æŸ¥ Neon ä¾è³´æ˜¯å¦å·²ç§»é™¤
  console.log('5ï¸âƒ£  æª¢æŸ¥ Neon ä¾è³´...');
  if (process.env.DATABASE_URL && !process.env.DATABASE_URL.includes('supabase')) {
    results.warnings.push('âš ï¸  ç™¼ç¾ DATABASE_URL ç’°å¢ƒè®Šæ•¸ä»æŒ‡å‘é Supabase è³‡æ–™åº«');
    results.warnings.push('   å»ºè­°ï¼šå°‡ DATABASE_URL ç§»é™¤æˆ–æ›´æ–°ç‚º SUPABASE_DB_URL');
  } else {
    results.passed.push('âœ… æœªç™¼ç¾ Neon ç›¸é—œç’°å¢ƒè®Šæ•¸');
  }

  // 6. æª¢æŸ¥è³‡æ–™ç­†æ•¸
  console.log('6ï¸âƒ£  æª¢æŸ¥è³‡æ–™ç­†æ•¸...');
  try {
    const { count: attendanceCount } = await client
      .from('trial_class_attendance')
      .select('*', { count: 'exact', head: true });

    const { count: purchaseCount } = await client
      .from('trial_class_purchase')
      .select('*', { count: 'exact', head: true });

    const { count: dealsCount } = await client
      .from('eods_for_closers')
      .select('*', { count: 'exact', head: true });

    results.passed.push(`âœ… trial_class_attendance: ${attendanceCount || 0} ç­†`);
    results.passed.push(`âœ… trial_class_purchase: ${purchaseCount || 0} ç­†`);
    results.passed.push(`âœ… eods_for_closers: ${dealsCount || 0} ç­†`);

    if ((attendanceCount || 0) === 0 && (purchaseCount || 0) === 0 && (dealsCount || 0) === 0) {
      results.warnings.push('âš ï¸  æ‰€æœ‰è³‡æ–™è¡¨éƒ½æ˜¯ç©ºçš„ï¼Œå¯èƒ½å°šæœªåŒæ­¥ Google Sheets è³‡æ–™');
    }

  } catch (e) {
    results.warnings.push(`âš ï¸  ç„¡æ³•è®€å–è³‡æ–™ç­†æ•¸: ${e}`);
  }

  // è¼¸å‡ºçµæœ
  console.log('\n' + '='.repeat(60));
  console.log('ğŸ“Š é©—è­‰çµæœçµ±è¨ˆ');
  console.log('='.repeat(60));
  console.log(`âœ… é€šé: ${results.passed.length} é …`);
  console.log(`âŒ å¤±æ•—: ${results.failed.length} é …`);
  console.log(`âš ï¸  è­¦å‘Š: ${results.warnings.length} é …`);
  console.log('='.repeat(60) + '\n');

  if (results.failed.length > 0) {
    console.log('âŒ å¤±æ•—é …ç›®ï¼š');
    results.failed.forEach(f => console.log(`   ${f}`));
    console.log('');
  }

  if (results.warnings.length > 0) {
    console.log('âš ï¸  è­¦å‘Šé …ç›®ï¼š');
    results.warnings.forEach(w => console.log(`   ${w}`));
    console.log('');
  }

  if (results.passed.length > 0) {
    console.log('âœ… é€šéé …ç›®ï¼š');
    results.passed.forEach(p => console.log(`   ${p}`));
    console.log('');
  }

  // æœ€çµ‚åˆ¤å®š
  if (results.failed.length === 0) {
    console.log('ğŸ‰ é·ç§»é©—è­‰æˆåŠŸï¼æ‰€æœ‰æ¸¬è©¦éƒ½é€šéäº†ã€‚\n');
    console.log('ğŸ“ ä¸‹ä¸€æ­¥ï¼š');
    console.log('   1. ç§»é™¤ .env ä¸­çš„ DATABASE_URL (Neon)');
    console.log('   2. åŸ·è¡Œ Google Sheets åŒæ­¥ä»¥å¡«å……è³‡æ–™');
    console.log('   3. æ¸¬è©¦æ‡‰ç”¨ç¨‹å¼æ‰€æœ‰åŠŸèƒ½æ˜¯å¦æ­£å¸¸');
    process.exit(0);
  } else {
    console.log('âŒ é·ç§»é©—è­‰å¤±æ•—ï¼Œè«‹ä¿®æ­£ä¸Šè¿°éŒ¯èª¤å¾Œé‡è©¦ã€‚\n');
    process.exit(1);
  }
}

verify().catch(error => {
  console.error('é©—è­‰éç¨‹ç™¼ç”ŸéŒ¯èª¤:', error);
  process.exit(1);
});
