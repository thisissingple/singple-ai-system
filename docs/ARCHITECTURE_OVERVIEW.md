# Google Sheets â†’ Supabase ç³»çµ±æ¶æ§‹ç¸½è¦½

**ç‰ˆæœ¬**: 2.0
**æ›´æ–°æ—¥æœŸ**: 2025-10-04

---

## ğŸ“ ç³»çµ±æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Google Sheets                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ é«”é©—èª²ä¸Šèª²è¨˜éŒ„  â”‚  â”‚ é«”é©—èª²è³¼è²·è¨˜éŒ„  â”‚  â”‚ EODs (å’¨è©¢)  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ Google Sheets API
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ETL Pipeline (Node.js)                       â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   Extract      â”‚â†’ â”‚   Transform    â”‚â†’ â”‚     Load       â”‚   â”‚
â”‚  â”‚                â”‚  â”‚                â”‚  â”‚                â”‚   â”‚
â”‚  â”‚ â€¢ æŠ½å–åŸå§‹è³‡æ–™   â”‚  â”‚ â€¢ æ¬„ä½æ˜ å°„       â”‚  â”‚ â€¢ åˆªé™¤èˆŠè³‡æ–™    â”‚   â”‚
â”‚  â”‚ â€¢ æ¸…ç†ç©ºåˆ—      â”‚  â”‚ â€¢ è³‡æ–™é©—è­‰       â”‚  â”‚ â€¢ æ‰¹æ¬¡æ’å…¥      â”‚   â”‚
â”‚  â”‚ â€¢ å»ºç«‹ header  â”‚  â”‚ â€¢ å‹åˆ¥è½‰æ›       â”‚  â”‚ â€¢ éŒ¯èª¤è™•ç†      â”‚   â”‚
â”‚  â”‚   mapping      â”‚  â”‚ â€¢ è£œå……ç³»çµ±æ¬„ä½    â”‚  â”‚                â”‚   â”‚
â”‚  â”‚                â”‚  â”‚ â€¢ ä¿å­˜ raw_data  â”‚  â”‚                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚  Field Mappings:                                                â”‚
â”‚  â€¢ configs/sheet-field-mappings-complete.ts                     â”‚
â”‚  â€¢ Transform functions (toDate, toInteger, toBoolean)           â”‚
â”‚  â€¢ Validation (required fields, student_email)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ Supabase Client
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Supabase (PostgreSQL)                        â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚               Business Tables                            â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  trial_class_attendance (é«”é©—èª²ä¸Šèª²è¨˜éŒ„)                  â”‚  â”‚
â”‚  â”‚  â€¢ åŸºç¤æ¬„ä½: student_email, student_name, class_date     â”‚  â”‚
â”‚  â”‚  â€¢ æ¥­å‹™æ¬„ä½: is_reviewed, no_conversion_reason          â”‚  â”‚
â”‚  â”‚  â€¢ ç³»çµ±æ¬„ä½: teacher_id, sales_id, department_id        â”‚  â”‚
â”‚  â”‚  â€¢ è¿½è¹¤æ¬„ä½: source_worksheet_id, origin_row_index      â”‚  â”‚
â”‚  â”‚  â€¢ raw_data: JSONB (æ‰€æœ‰åŸå§‹æ¬„ä½)                        â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  trial_class_purchase (é«”é©—èª²è³¼è²·è¨˜éŒ„)                   â”‚  â”‚
â”‚  â”‚  eods_for_closers (å’¨è©¢å¸«æ¥­ç¸¾)                           â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  JOIN Key: student_email (æ‰€æœ‰è¡¨å…±ç”¨)                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚               Report Views                               â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  â€¢ v_student_journey (å­¸ç”Ÿå®Œæ•´æ—…ç¨‹)                       â”‚  â”‚
â”‚  â”‚  â€¢ v_teacher_performance (è€å¸«æ¥­ç¸¾)                      â”‚  â”‚
â”‚  â”‚  â€¢ v_closer_performance (å’¨è©¢å¸«æ¥­ç¸¾)                      â”‚  â”‚
â”‚  â”‚  â€¢ v_caller_performance (é›»è¨ªæ¥­ç¸¾)                        â”‚  â”‚
â”‚  â”‚  â€¢ v_daily_statistics (æ¯æ—¥çµ±è¨ˆ)                          â”‚  â”‚
â”‚  â”‚  â€¢ v_monthly_statistics (æ¯æœˆçµ±è¨ˆ)                        â”‚  â”‚
â”‚  â”‚  â€¢ v_conversion_funnel (è½‰æ›æ¼æ–—)                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚               Functions                                  â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  â€¢ get_student_journey(email)                           â”‚  â”‚
â”‚  â”‚  â€¢ get_teacher_performance(name, start, end)            â”‚  â”‚
â”‚  â”‚  â€¢ get_conversion_statistics(start, end)                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  Indexes:                                                       â”‚
â”‚  â€¢ student_email (B-tree) - JOIN å„ªåŒ–                           â”‚
â”‚  â€¢ class_date, purchase_date, deal_date - æ™‚é–“ç¯„åœæŸ¥è©¢           â”‚
â”‚  â€¢ teacher_name, closer_name, caller_name - æ¥­å‹™æŸ¥è©¢            â”‚
â”‚  â€¢ raw_data (GIN) - JSONB æŸ¥è©¢                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ PostgREST API
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Frontend (React + TypeScript)                â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Dashboard     â”‚  â”‚   Reports      â”‚  â”‚  AI Analysis   â”‚   â”‚
â”‚  â”‚                â”‚  â”‚                â”‚  â”‚                â”‚   â”‚
â”‚  â”‚ â€¢ KPI å¡ç‰‡     â”‚  â”‚ â€¢ è€å¸«æ¥­ç¸¾å ±è¡¨   â”‚  â”‚ â€¢ è½‰æ›é æ¸¬      â”‚   â”‚
â”‚  â”‚ â€¢ å³æ™‚çµ±è¨ˆ     â”‚  â”‚ â€¢ å’¨è©¢å¸«æ¥­ç¸¾     â”‚  â”‚ â€¢ è¶¨å‹¢åˆ†æ      â”‚   â”‚
â”‚  â”‚ â€¢ åœ–è¡¨è¦–è¦ºåŒ–   â”‚  â”‚ â€¢ å­¸ç”Ÿæ—…ç¨‹       â”‚  â”‚ â€¢ ç•°å¸¸åµæ¸¬      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚  Data Fetching:                                                 â”‚
â”‚  â€¢ React Query (å¿«å–ã€é‡è©¦ã€è‡ªå‹•åˆ·æ–°)                             â”‚
â”‚  â€¢ Supabase Client (ç›´æ¥æŸ¥è©¢ views å’Œ tables)                    â”‚
â”‚  â€¢ Real-time subscriptions (å³æ™‚æ›´æ–°)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ï¸ æ ¸å¿ƒè¨­è¨ˆåŸå‰‡

### 1. Single Source of Truth

**Supabase æ˜¯å”¯ä¸€çš„è³‡æ–™çœŸå¯¦ä¾†æº**ï¼Œæ‰€æœ‰å‰ç«¯å ±è¡¨ã€AI åˆ†æéƒ½åªæŸ¥è©¢ Supabaseã€‚

### 2. raw_data ç­–ç•¥

æ‰€æœ‰ Google Sheets æ¬„ä½éƒ½ä¿å­˜åœ¨ `raw_data` JSONB æ¬„ä½ä¸­ï¼š
- **å„ªé»**: æœªä¾†æ–°å¢æ¬„ä½ç„¡éœ€ schema migration
- **ç”¨é€”**: æ–°æ¬„ä½å¯ç›´æ¥å¾ `raw_data` æŸ¥è©¢
- **æŸ¥è©¢**: `SELECT raw_data->>'æ–°æ¬„ä½' FROM table`

### 3. ETL åˆ†é›¢

Extractã€Transformã€Load ä¸‰å€‹éšæ®µå®Œå…¨åˆ†é›¢ï¼š
- **Extract**: æŠ½å–åŸå§‹è³‡æ–™ï¼Œä¸åšä»»ä½•æ¥­å‹™é‚è¼¯
- **Transform**: æ¬„ä½æ˜ å°„ã€é©—è­‰ã€æ¸…æ´—
- **Load**: åˆªé™¤èˆŠè³‡æ–™ã€æ‰¹æ¬¡æ’å…¥æ–°è³‡æ–™

### 4. è³‡æ–™æº¯æº

æ¯ç­†è³‡æ–™éƒ½åŒ…å«ï¼š
- `source_worksheet_id`: ä¾†æºå·¥ä½œè¡¨ ID
- `origin_row_index`: Google Sheets åŸå§‹åˆ—è™Ÿ
- `synced_at`: åŒæ­¥æ™‚é–“

å¯å®Œæ•´è¿½è¹¤è³‡æ–™ä¾†æºå’ŒåŒæ­¥æ­·å²ã€‚

### 5. å ±è¡¨å„ªåŒ–

ä½¿ç”¨ PostgreSQL Views å’Œ Functions å„ªåŒ–å¸¸ç”¨æŸ¥è©¢ï¼š
- **Views**: é å…ˆè¨ˆç®—çµ±è¨ˆè³‡æ–™
- **Functions**: æ”¯æ´åƒæ•¸åŒ–æŸ¥è©¢
- **Indexes**: å„ªåŒ– JOIN å’Œç¯„åœæŸ¥è©¢

---

## ğŸ“ å°ˆæ¡ˆçµæ§‹

```
workspace/
â”œâ”€â”€ configs/
â”‚   â”œâ”€â”€ sheet-field-mappings-complete.ts    # å®Œæ•´æ¬„ä½æ˜ å°„
â”‚   â””â”€â”€ supabase-schema-authority.ts        # Schema æ¬Šå¨å®šç¾©
â”‚
â”œâ”€â”€ server/
â”‚   â””â”€â”€ services/
â”‚       â”œâ”€â”€ etl/
â”‚       â”‚   â”œâ”€â”€ extract.ts                  # Extract æ¨¡çµ„
â”‚       â”‚   â”œâ”€â”€ transform.ts                # Transform æ¨¡çµ„
â”‚       â”‚   â”œâ”€â”€ load.ts                     # Load æ¨¡çµ„
â”‚       â”‚   â””â”€â”€ index.ts                    # ETL Pipeline
â”‚       â”œâ”€â”€ sheet-sync-service-v2.ts        # æ–°ç‰ˆåŒæ­¥æœå‹™
â”‚       â””â”€â”€ supabase-client.ts              # Supabase å®¢æˆ¶ç«¯
â”‚
â”œâ”€â”€ supabase/
â”‚   â””â”€â”€ migrations/
â”‚       â”œâ”€â”€ 008_complete_business_schema.sql  # å®Œæ•´æ¥­å‹™ Schema
â”‚       â””â”€â”€ 009_create_report_views.sql       # å ±è¡¨è¦–åœ–å’Œå‡½æ•¸
â”‚
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ etl/
â”‚   â”‚   â”œâ”€â”€ extract.test.ts                 # Extract æ¸¬è©¦
â”‚   â”‚   â””â”€â”€ transform.test.ts               # Transform æ¸¬è©¦
â”‚   â””â”€â”€ schema-validation.test.ts           # Schema é©—è­‰æ¸¬è©¦
â”‚
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ ARCHITECTURE_OVERVIEW.md            # æœ¬æ–‡ä»¶
â”‚   â”œâ”€â”€ COMPLETE_OPERATION_MANUAL.md        # å®Œæ•´æ“ä½œæ‰‹å†Š
â”‚   â”œâ”€â”€ FIELD_MAPPING_COMPLETE.md           # æ¬„ä½æ˜ å°„æ–‡ä»¶
â”‚   â””â”€â”€ QUICK_DEPLOYMENT_GUIDE.md           # å¿«é€Ÿéƒ¨ç½²æŒ‡å—
â”‚
â””â”€â”€ shared/
    â””â”€â”€ schema.ts                            # Drizzle ORM Schema
```

---

## ğŸ”„ è³‡æ–™æµç¨‹è©³è§£

### åŒæ­¥æµç¨‹

```typescript
// 1. å¾ Google Sheets æŠ½å–è³‡æ–™
const extractedData = extractFromSheets(worksheet, headers, dataRows);
// â†“
// {
//   worksheet: { id, name, supabaseTable },
//   headers: ['å§“å', 'email', 'ä¸Šèª²æ—¥æœŸ'],
//   rows: [{ 'å§“å': 'ç‹å°æ˜', 'email': 'wang@example.com', ... }],
//   totalRows: 100
// }

// 2. è½‰æ›ç‚º Supabase æ ¼å¼
const transformResult = transformData(extractedData);
// â†“
// {
//   records: [
//     {
//       data: {
//         student_name: 'ç‹å°æ˜',
//         student_email: 'wang@example.com',
//         class_date: '2025-10-01',
//         raw_data: { 'å§“å': 'ç‹å°æ˜', 'email': '...', ... },
//         source_worksheet_id: 'xxx',
//         origin_row_index: 0,
//         synced_at: '2025-10-04T12:00:00Z'
//       },
//       isValid: true,
//       validationErrors: []
//     }
//   ],
//   validCount: 95,
//   invalidCount: 5
// }

// 3. è¼‰å…¥åˆ° Supabase
const loadResult = await loadToSupabase(transformResult);
// â†“
// {
//   tableName: 'trial_class_attendance',
//   insertedCount: 95,
//   deletedCount: 90,  // åˆªé™¤èˆŠè³‡æ–™
//   errors: []
// }
```

### æŸ¥è©¢æµç¨‹

```typescript
// å‰ç«¯æŸ¥è©¢ï¼ˆä½¿ç”¨ Viewï¼‰
const { data } = await supabase
  .from('v_teacher_performance')
  .select('*')
  .order('conversion_rate', { ascending: false });

// â†“ PostgREST è‡ªå‹•ç”¢ç”Ÿ SQL
// SELECT * FROM v_teacher_performance
// ORDER BY conversion_rate DESC;

// â†“ View å®šç¾©è‡ªå‹• JOIN ä¸¦è¨ˆç®—çµ±è¨ˆè³‡æ–™
// è¿”å›çµæœ:
// [
//   {
//     teacher_name: 'æè€å¸«',
//     total_students: 50,
//     total_classes: 75,
//     converted_students: 35,
//     conversion_rate: 70.00
//   },
//   ...
// ]
```

---

## ğŸ” å®‰å…¨æ€§è¨­è¨ˆ

### Row Level Security (RLS)

æ‰€æœ‰æ¥­å‹™è¡¨éƒ½å•Ÿç”¨ RLSï¼š

```sql
-- service_role å®Œå…¨å­˜å–ï¼ˆç”¨æ–¼åŒæ­¥æœå‹™ï¼‰
CREATE POLICY "Service role has full access"
  ON trial_class_attendance
  FOR ALL TO service_role
  USING (true);

-- authenticated users åªèƒ½è®€å–ï¼ˆç”¨æ–¼å‰ç«¯æŸ¥è©¢ï¼‰
CREATE POLICY "Authenticated users can read"
  ON trial_class_attendance
  FOR SELECT TO authenticated
  USING (true);
```

### æ¬Šé™è¨­è¨ˆ

| è§’è‰² | æ¬Šé™ | ç”¨é€” |
|-----|------|------|
| `service_role` | å®Œå…¨å­˜å–ï¼ˆè®€å¯«åˆªï¼‰ | å¾Œç«¯åŒæ­¥æœå‹™ |
| `authenticated` | åƒ…è®€å– | å‰ç«¯æŸ¥è©¢ |
| `anon` | ç„¡æ¬Šé™ | æœªç™»å…¥ä½¿ç”¨è€… |

---

## ğŸ“Š è³‡æ–™åº« Schema è¨­è¨ˆ

### æ ¸å¿ƒæ¬„ä½åˆ†é¡

#### 1. æ¥­å‹™æ¬„ä½ï¼ˆMapped Fieldsï¼‰

å®šç¾©åœ¨ `sheet-field-mappings-complete.ts`ï¼Œç›´æ¥æ˜ å°„è‡ª Google Sheetsã€‚

**ç”¨é€”**: å¿«é€ŸæŸ¥è©¢ã€JOINã€å»ºç«‹ç´¢å¼•

**ç¯„ä¾‹**:
- `student_email` (JOIN éµ)
- `student_name`
- `class_date`
- `teacher_name`

#### 2. ç³»çµ±æ¬„ä½ï¼ˆSystem Fieldsï¼‰

ç”±ç³»çµ±è‡ªå‹•è£œå……ï¼Œä¸å¾ Google Sheets è®€å–ã€‚

**ç”¨é€”**: æ”¯æ´æ¥­å‹™é‚è¼¯ã€æ¬Šé™æ§åˆ¶

**ç¯„ä¾‹**:
- `teacher_id`
- `sales_id`
- `department_id`

#### 3. è¿½è¹¤æ¬„ä½ï¼ˆTracking Fieldsï¼‰

ç”¨æ–¼è³‡æ–™æº¯æºå’ŒåŒæ­¥ç®¡ç†ã€‚

**ç”¨é€”**: è¿½è¹¤è³‡æ–™ä¾†æºã€æ”¯æ´å¢é‡åŒæ­¥

**ç¯„ä¾‹**:
- `source_worksheet_id`
- `origin_row_index`
- `synced_at`

#### 4. raw_data (JSONB)

å„²å­˜æ‰€æœ‰ Google Sheets åŸå§‹æ¬„ä½ã€‚

**ç”¨é€”**: ä¿ç•™å®Œæ•´è³‡æ–™ã€æ”¯æ´æœªä¾†æ“´å……

**ç¯„ä¾‹**:
```json
{
  "å§“å": "ç‹å°æ˜",
  "email": "wang@example.com",
  "ä¸Šèª²æ—¥æœŸ": "2025-10-01",
  "æ˜¯å¦å·²å¯©æ ¸": "true",
  "æœªä¾†æ–°å¢æ¬„ä½": "æ–°è³‡æ–™"
}
```

---

## ğŸš€ æ•ˆèƒ½å„ªåŒ–

### ç´¢å¼•ç­–ç•¥

#### B-tree ç´¢å¼•ï¼ˆç”¨æ–¼ç²¾ç¢ºæŸ¥è©¢å’Œ JOINï¼‰

```sql
CREATE INDEX idx_trial_attendance_email ON trial_class_attendance(student_email);
CREATE INDEX idx_trial_attendance_teacher ON trial_class_attendance(teacher_name);
```

#### è¤‡åˆç´¢å¼•ï¼ˆç”¨æ–¼å¤šæ¢ä»¶æŸ¥è©¢ï¼‰

```sql
CREATE INDEX idx_eods_closer_date ON eods_for_closers(closer_name, deal_date DESC);
```

#### GIN ç´¢å¼•ï¼ˆç”¨æ–¼ JSONB æŸ¥è©¢ï¼‰

```sql
CREATE INDEX idx_trial_attendance_raw_data_gin ON trial_class_attendance USING gin(raw_data);
```

#### éƒ¨åˆ†ç´¢å¼•ï¼ˆç”¨æ–¼ç‰¹å®šæ¢ä»¶æŸ¥è©¢ï¼‰

```sql
CREATE INDEX idx_trial_attendance_reviewed
  ON trial_class_attendance(is_reviewed)
  WHERE is_reviewed = FALSE;
```

### æŸ¥è©¢å„ªåŒ–

#### ä½¿ç”¨ Views æ¸›å°‘é‡è¤‡è¨ˆç®—

```sql
-- ä¸è¦æ¯æ¬¡éƒ½ JOIN ä¸‰å¼µè¡¨
-- âŒ Bad
SELECT ... FROM trial_class_attendance a
JOIN trial_class_purchase p ON a.student_email = p.student_email
JOIN eods_for_closers e ON a.student_email = e.student_email
...

-- âœ… Good
SELECT * FROM v_student_journey WHERE student_email = 'xxx';
```

#### ä½¿ç”¨ Functions æ”¯æ´åƒæ•¸åŒ–æŸ¥è©¢

```sql
-- âœ… Good
SELECT * FROM get_teacher_performance('æè€å¸«', '2025-10-01', '2025-10-31');
```

---

## ğŸ§ª æ¸¬è©¦ç­–ç•¥

### å–®å…ƒæ¸¬è©¦

- **Extract Module**: æ¸¬è©¦è³‡æ–™æŠ½å–ã€ç©ºåˆ—è™•ç†ã€å€¼æ¸…ç†
- **Transform Module**: æ¸¬è©¦æ¬„ä½æ˜ å°„ã€å‹åˆ¥è½‰æ›ã€é©—è­‰é‚è¼¯
- **Load Module**: æ¸¬è©¦æ‰¹æ¬¡æ’å…¥ã€å»é‡é‚è¼¯

### æ•´åˆæ¸¬è©¦

- **ETL Pipeline**: æ¸¬è©¦å®Œæ•´æµç¨‹ï¼ˆExtract â†’ Transform â†’ Loadï¼‰
- **Schema Validation**: ç¢ºä¿ transformer è¼¸å‡ºèˆ‡ schema å®šç¾©ä¸€è‡´

### ç«¯å°ç«¯æ¸¬è©¦

- **Sync Service**: æ¸¬è©¦å®Œæ•´åŒæ­¥æµç¨‹
- **Report Queries**: æ¸¬è©¦å ±è¡¨è¦–åœ–å’Œå‡½æ•¸

---

## ğŸ“ˆ å¯æ“´å±•æ€§

### æ–°å¢è¡¨

1. åœ¨ `shared/schema.ts` å®šç¾© Drizzle schema
2. å»ºç«‹ migration SQL
3. æ–°å¢ field mapping åˆ° `sheet-field-mappings-complete.ts`
4. æ›´æ–° ETL pipeline æ”¯æ´æ–°è¡¨
5. æ–°å¢æ¸¬è©¦

### æ–°å¢æ¬„ä½

#### é¸é … 1: åƒ…å­˜ raw_dataï¼ˆé›¶åœæ©Ÿï¼‰

ä¸éœ€è¦ä»»ä½•æ“ä½œï¼Œæ–°æ¬„ä½è‡ªå‹•å­˜å…¥ `raw_data`ã€‚

#### é¸é … 2: æ–°å¢å°ˆç”¨æ¬„ä½ï¼ˆæ”¯æ´ç´¢å¼•ï¼‰

1. æ›´æ–° field mapping
2. æ›´æ–° schema authority
3. å»ºç«‹ migration SQL
4. åŸ·è¡Œæ¸¬è©¦
5. éƒ¨ç½²

### æ–°å¢å ±è¡¨

1. å»ºç«‹ View æˆ– Function
2. å»ºç«‹ migration SQL
3. æ–°å¢å‰ç«¯ hook
4. æ–°å¢ UI å…ƒä»¶

---

## ğŸ”§ ç¶­è­·å»ºè­°

### æ—¥å¸¸æª¢æŸ¥

- ç›£æ§åŒæ­¥æˆåŠŸç‡
- æª¢æŸ¥è³‡æ–™æ–°é®®åº¦ï¼ˆ`MAX(synced_at)`ï¼‰
- æŸ¥çœ‹éŒ¯èª¤æ—¥èªŒ

### å®šæœŸå„ªåŒ–

- æ¸…ç†éæœŸçš„ `sync_history`
- åˆ†ææ…¢æŸ¥è©¢ä¸¦å»ºç«‹ç´¢å¼•
- æª¢è¦– `raw_data` ä½¿ç”¨æƒ…æ³ï¼Œè€ƒæ…®æ˜¯å¦æ–°å¢å°ˆç”¨æ¬„ä½

### å®¹é‡è¦åŠƒ

- ç›£æ§è³‡æ–™åº«å¤§å°
- è©•ä¼°ç´¢å¼•å¤§å°
- è¦åŠƒè³‡æ–™æ­¸æª”ç­–ç•¥

---

## ğŸ“š ç›¸é—œæ–‡ä»¶

- [å®Œæ•´æ“ä½œæ‰‹å†Š](./COMPLETE_OPERATION_MANUAL.md)
- [å¿«é€Ÿéƒ¨ç½²æŒ‡å—](./QUICK_DEPLOYMENT_GUIDE.md)
- [Field Mapping æ–‡ä»¶](./FIELD_MAPPING_COMPLETE.md)
- [Schema Fix åŸ·è¡ŒæŒ‡å—](../SCHEMA_FIX_EXECUTION_GUIDE.md)

---

**æ¶æ§‹è¨­è¨ˆ**: éµå¾ª ETL æœ€ä½³å¯¦è¸ã€Single Source of Truth åŸå‰‡ã€è³‡æ–™æº¯æºèƒ½åŠ›
**æŠ€è¡“æ£§**: Node.js + TypeScript + Supabase (PostgreSQL) + React
**éƒ¨ç½²ç’°å¢ƒ**: Replit + Supabase Cloud
