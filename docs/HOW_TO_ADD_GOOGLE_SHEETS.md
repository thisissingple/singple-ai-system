# 如何新增 Google Sheets 到系統

## 🎯 完整操作步驟

### Step 1: 前往 Dashboard 頁面

開啟瀏覽器前往：
```
http://localhost:5000/dashboard
```

---

### Step 2: 找到「Google Sheets 管理」區塊

在頁面中找到標籤頁，點擊 **「sheets」** tab（如果不在該頁面）

您會看到：

```
┌─────────────────────────────────────────────────┐
│ ➕ 添加新的 Google Sheets                        │
├─────────────────────────────────────────────────┤
│ 表格名稱 *                  Google Sheets URL *  │
│ ┌────────────────────┐    ┌──────────────────┐ │
│ │ 例如：學員資料表    │    │ https://docs...  │ │
│ └────────────────────┘    └──────────────────┘ │
│                                                 │
│ 描述（可選）                                     │
│ ┌──────────────────────────────────────────┐   │
│ │ 簡述這個表格的用途                         │   │
│ └──────────────────────────────────────────┘   │
│                                                 │
│ [添加表格] [初始化報表測試數據源]                │
└─────────────────────────────────────────────────┘
```

---

### Step 3: 填寫表單

#### 3.1 表格名稱（必填）
輸入一個好記的名稱，例如：
- `體驗課上課記錄`
- `體驗課購買名單`
- `EODs 成交記錄`

#### 3.2 Google Sheets URL（必填）
貼上您的 Google Sheets 完整網址，格式如：
```
https://docs.google.com/spreadsheets/d/1abcdefghijklmnopqrstuvwxyz1234567890/edit#gid=0
```

**如何取得 URL**：
1. 打開您的 Google Sheets
2. 複製瀏覽器網址列的完整網址
3. 貼到此欄位

#### 3.3 描述（可選）
選填，例如：
- `記錄學生體驗課出席狀況`
- `追蹤體驗課轉換成正式學員的資料`

---

### Step 4: 點擊「添加表格」

系統會自動執行以下動作：

```
1️⃣ 從 URL 提取 Spreadsheet ID
   ↓
2️⃣ 驗證 Google Sheets 權限
   ↓
3️⃣ 讀取所有工作表（worksheets）
   ↓
4️⃣ 下載資料到 Local Storage
   ↓
5️⃣ 自動同步到 Supabase（根據工作表名稱判斷目標表）
   ↓
6️⃣ 顯示成功訊息
```

**成功後會看到**：
```
✅ 創建成功
   新的 Google Sheets 已添加
```

---

### Step 5: 檢查已添加的表格

表單下方會出現「Google Sheets 列表」：

```
┌─────────────────────────────────────────────────┐
│ 📄 Google Sheets 列表                            │
├─────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────┐ │
│ │ 體驗課上課記錄                               │ │
│ │ 建立時間: 2025-10-01 20:30 | 最後同步: ...   │ │
│ │ [🔗] [🔄] [🗑️]  [> 查看工作表]              │ │
│ └─────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────┘
```

**按鈕說明**：
- 🔗 = 開啟 Google Sheets（新分頁）
- 🔄 = 手動同步資料
- 🗑️ = 刪除此表格
- **> 查看工作表** = 展開查看內部的 sheets

---

### Step 6: 啟用工作表（Worksheets）

點擊「查看工作表」後會展開：

```
┌─────────────────────────────────────────────────┐
│ 工作表                                           │
├─────────────────────────────────────────────────┤
│ Sheet1              [👁️ 查看資料] [開關] 啟用   │
│ 體驗課資料          [👁️ 查看資料] [開關] 停用   │
│ 購買記錄            [👁️ 查看資料] [開關] 停用   │
└─────────────────────────────────────────────────┘
```

**重要**：
- 將 **[開關]** 切換到「啟用」
- 系統會自動同步該工作表到 Supabase
- 只有「啟用」的工作表會被同步

---

### Step 7: 驗證同步到 Supabase

#### 方法 1：前往總報表頁面
```
http://localhost:5000/dashboard/total-report
```

檢查：
- 是否顯示「即時資料模式 · 資料來源：Supabase」
- KPI 數字是否有值
- 是否顯示「使用 Supabase 資料來源（XX 筆記錄）」

#### 方法 2：直接查詢 Supabase
1. 登入 Supabase Dashboard
2. 前往 Table Editor
3. 查看三張表是否有資料：
   - `trial_class_attendance`
   - `trial_class_purchase`
   - `eods_for_closers`

#### 方法 3：點擊「欄位盤點」
前往總報表頁面，點擊控制面板的「欄位盤點」按鈕，應該顯示：
```
✓ 已分析 X 個資料表，共 XX 個欄位
```

---

## 🔄 自動同步機制

系統會 **每 5 分鐘** 自動重新同步所有已啟用的 Google Sheets！

您也可以隨時手動點擊 🔄 按鈕觸發同步。

---

## 📊 工作表名稱自動識別

系統會根據工作表名稱自動判斷要同步到哪張 Supabase 表：

| 工作表名稱包含 | 同步到 Supabase 表 |
|--------------|-------------------|
| `體驗課上課` 或 `上課打卡` | `trial_class_attendance` |
| `體驗課購買` 或 `體驗課學員` | `trial_class_purchase` |
| `EODs` 或 `升高階` 或 `成交` | `eods_for_closers` |

**範例**：
- 工作表名稱：`體驗課上課記錄_2025` → 同步到 `trial_class_attendance`
- 工作表名稱：`2025 體驗課購買名單` → 同步到 `trial_class_purchase`
- 工作表名稱：`EODs for Closers` → 同步到 `eods_for_closers`

---

## ⚠️ 常見問題

### Q1: 顯示「無效的 Google Sheets URL」
**A**: 請確認 URL 格式正確：
```
https://docs.google.com/spreadsheets/d/【ID】/edit#gid=0
```

### Q2: 顯示「Invalid spreadsheet ID or access denied」
**A**: 請確認 Google Sheets 已分享給 Service Account：
```
replit@replit-473109.iam.gserviceaccount.com
```
權限設定為「檢視者」即可。

### Q3: 添加成功但沒有資料同步到 Supabase
**A**:
1. 確認工作表已「啟用」（開關切到「啟用」）
2. 檢查工作表名稱是否包含識別關鍵字
3. 手動點擊 🔄 按鈕重新同步

### Q4: 欄位對應不正確
**A**: 前往總報表頁面，使用「欄位對應管理」功能調整欄位別名。

---

## 📝 建議的使用流程

### 首次設定
1. 添加 3 張 Google Sheets（體驗課上課、購買、成交）
2. 展開每張表，啟用對應的工作表
3. 等待自動同步完成
4. 前往總報表頁面驗證資料

### 日常使用
- 在 Google Sheets 中更新資料
- 系統會每 5 分鐘自動同步
- 或手動點擊 🔄 立即同步
- 前往總報表查看最新統計

---

## ✨ 提示

- **一個 Google Sheets 可以包含多個工作表（worksheets）**
- **只需添加一次，系統會自動讀取所有工作表**
- **可以選擇性啟用/停用特定工作表**
- **同步是雙向安全的（只讀取，不會修改 Google Sheets）**

---

**版本**: v1.0
**最後更新**: 2025-10-01
