# KPI Calculator åŠŸèƒ½å®Œæˆç¸½çµ

## ğŸ‰ å·²å®Œæˆçš„åŠŸèƒ½

### å¾Œç«¯ (Backend)

#### 1. KPI Calculator Service
**æª”æ¡ˆ**: [server/services/kpi-calculator.ts](server/services/kpi-calculator.ts)

- âœ… é‡æ§‹ `calculateAllKPIs()` å‡½æ•¸
- âœ… æ–°å¢ `CalculationDetail` ä»‹é¢ï¼ŒåŒ…å« 4 å€‹æ­¥é©Ÿï¼š
  - **Step 1**: åŸºç¤è®Šæ•¸ (`step1_baseVariables`)
  - **Step 2**: ä¸­é–“è¨ˆç®— (`step2_intermediateCalculations`)
  - **Step 3**: å…¬å¼ Context (`step3_formulaContext`)
  - **Step 4**: KPI è¨ˆç®—çµæœ (`step4_kpiCalculations`)
- âœ… å›å‚³å®Œæ•´çš„è¨ˆç®—éç¨‹å’Œ warnings

#### 2. Formula Engine
**æª”æ¡ˆ**: [server/services/reporting/formula-engine.ts](server/services/reporting/formula-engine.ts)

- âœ… æ–°å¢ `calculateMetricWithDebug()` æ–¹æ³•
- âœ… å›å‚³è©³ç´°çš„é™¤éŒ¯è³‡è¨Šï¼š
  - åŸå§‹å…¬å¼
  - ä»£å…¥å¾Œçš„å…¬å¼
  - è¨ˆç®—çµæœ

#### 3. Total Report Service
**æª”æ¡ˆ**: [server/services/reporting/total-report-service.ts](server/services/reporting/total-report-service.ts)

- âœ… æ›´æ–° `calculateSummaryMetrics()` é©é…æ–°çš„ KPI Calculator
- âœ… è‡ªå‹•åˆä½µ warnings åˆ°å ±è¡¨ä¸­

#### 4. API Routes
**æª”æ¡ˆ**: [server/routes.ts](server/routes.ts)

- âœ… æ–°å¢ `POST /api/kpi-calculator/detail`
  - æ¥æ”¶ `period`, `baseDate`, `startDate`, `endDate`
  - å›å‚³å®Œæ•´çš„è¨ˆç®—éç¨‹å’Œçµæœ
- âœ… ç¢ºèª `GET /api/report-metrics/config` å®Œæ•´å¯ç”¨

---

### å‰ç«¯ (Frontend)

#### 1. KPI Calculator Dashboard
**æª”æ¡ˆ**: [client/src/pages/dashboard-kpi-calculator.tsx](client/src/pages/dashboard-kpi-calculator.tsx)

æ–°å»ºå®Œæ•´çš„ KPI è¨ˆç®—å™¨é é¢ï¼ŒåŒ…å«ï¼š

- âœ… **4 å€‹ Tab åˆ†é **ï¼š
  - Step 1: åŸºç¤è®Šæ•¸ (Base Variables)
  - Step 2: ä¸­é–“è¨ˆç®— (Intermediate Calculations)
  - Step 3: å…¬å¼ Context (Formula Context)
  - Step 4: KPI çµæœ (KPI Calculations)

- âœ… **è©³ç´°é¡¯ç¤ºæ¯å€‹ KPI**ï¼š
  - å…¬å¼ (Formula)
  - ä»£å…¥è®Šæ•¸ (Variables)
  - è¨ˆç®—éç¨‹ (Substituted Formula)
  - æœ€çµ‚çµæœ (Final Result)
  - è­¦å‘Šè¨Šæ¯ (Warnings)

- âœ… **è³‡æ–™ä¾†æºæŒ‡ç¤º**ï¼š
  - é¡¯ç¤ºæœŸé–“ç¯„åœ
  - é¡¯ç¤ºè³‡æ–™ä¾†æº (Supabase / Local Storage)
  - é‡æ–°è¨ˆç®—æŒ‰éˆ•

#### 2. Dashboard Integration
**æª”æ¡ˆ**: [client/src/pages/dashboard.tsx](client/src/pages/dashboard.tsx)

- âœ… åŒ¯å…¥ `DashboardKPICalculator` çµ„ä»¶
- âœ… æ–°å¢ Tab: "KPI è¨ˆç®—å™¨"
- âœ… æ•´åˆåˆ°ä¸» Dashboard

#### 3. Total Report Enhancement
**æª”æ¡ˆ**: [client/src/pages/dashboard-total-report.tsx](client/src/pages/dashboard-total-report.tsx)

- âœ… å·²åŒ…å« Supabase ç‹€æ…‹é¡¯ç¤º
- âœ… é¡¯ç¤ºè³‡æ–™ä¾†æºçµ±è¨ˆ

---

## ğŸ“Š ç³»çµ±æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ä½¿ç”¨è€…ä»‹é¢                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Dashboard                                                   â”‚
â”‚  â”œâ”€ Google Sheets ç®¡ç†                                       â”‚
â”‚  â”œâ”€ æˆ°åŠ›å ±è¡¨                                                 â”‚
â”‚  â”œâ”€ æ•¸æ“šç¸½å ±è¡¨ (Total Report) â† Supabase ç‹€æ…‹é¡¯ç¤º           â”‚
â”‚  â””â”€ KPI è¨ˆç®—å™¨ (KPI Calculator) â† ğŸ†• æ–°åŠŸèƒ½                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        API å±¤                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  GET  /api/report-metrics/config                            â”‚
â”‚  POST /api/kpi-calculator/detail â† ğŸ†•                        â”‚
â”‚  GET  /api/reports/total-report                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æœå‹™å±¤ (Services)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  KPI Calculator (kpi-calculator.ts)                         â”‚
â”‚  â”œâ”€ calculateAllKPIs() â† ğŸ”„ é‡æ§‹                             â”‚
â”‚  â”œâ”€ Step 1: Base Variables                                  â”‚
â”‚  â”œâ”€ Step 2: Intermediate Calculations                       â”‚
â”‚  â”œâ”€ Step 3: Formula Context                                 â”‚
â”‚  â””â”€ Step 4: KPI Calculations                                â”‚
â”‚                                                              â”‚
â”‚  Formula Engine (formula-engine.ts)                         â”‚
â”‚  â”œâ”€ calculateMetricWithDebug() â† ğŸ†•                          â”‚
â”‚  â””â”€ validateFormula()                                       â”‚
â”‚                                                              â”‚
â”‚  Total Report Service (total-report-service.ts)             â”‚
â”‚  â”œâ”€ generateReport()                                        â”‚
â”‚  â”œâ”€ fetchRawData() (Supabase â†’ Storage fallback)            â”‚
â”‚  â””â”€ calculateSummaryMetrics() â† ğŸ”„ é©é…æ–°æ ¼å¼                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      è³‡æ–™å±¤ (Data)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Supabase (å„ªå…ˆ)                                             â”‚
â”‚  â”œâ”€ trial_class_attendance                                  â”‚
â”‚  â”œâ”€ trial_class_purchase                                    â”‚
â”‚  â””â”€ eods_for_closers                                        â”‚
â”‚                                                              â”‚
â”‚  Local Storage (å‚™æ´)                                        â”‚
â”‚  â””â”€ SQLite DB                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§ª æ¸¬è©¦æŒ‡å—

### 1. å•Ÿå‹•é–‹ç™¼ä¼ºæœå™¨

```bash
npm run dev
```

### 2. æ¸¬è©¦æ•¸æ“šç¸½å ±è¡¨

1. è¨ªå• Dashboard
2. åˆ‡æ›åˆ°ã€Œæ•¸æ“šç¸½å ±è¡¨ã€Tab
3. ç¢ºèªé¡¯ç¤ºï¼š
   - âœ… Supabase ç‹€æ…‹ï¼ˆè³‡æ–™ä¾†æºã€ç­†æ•¸ï¼‰
   - âœ… ç¶ è‰²æç¤ºæ¡†é¡¯ç¤ºå³æ™‚è³‡æ–™
   - âœ… Warningsï¼ˆå¦‚æœ‰ï¼‰

### 3. æ¸¬è©¦ KPI è¨ˆç®—å™¨

1. åœ¨ Dashboard åˆ‡æ›åˆ°ã€ŒKPI è¨ˆç®—å™¨ã€Tab
2. æŸ¥çœ‹ 4 å€‹è¨ˆç®—æ­¥é©Ÿï¼š
   - **Step 1**: ç¢ºèªåŸºç¤è®Šæ•¸å€¼æ­£ç¢º
   - **Step 2**: æŸ¥çœ‹ä¸­é–“è¨ˆç®—éç¨‹
   - **Step 3**: ç¢ºèªæ‰€æœ‰ context è®Šæ•¸
   - **Step 4**: æŸ¥çœ‹æ¯å€‹ KPI çš„è©³ç´°è¨ˆç®—
3. é»æ“Šã€Œé‡æ–°è¨ˆç®—ã€æŒ‰éˆ•æ¸¬è©¦é‡æ–°è¼‰å…¥

### 4. API æ¸¬è©¦

#### æ¸¬è©¦ KPI Calculator Detail API

```bash
curl -X POST http://localhost:5000/api/kpi-calculator/detail \
  -H 'Content-Type: application/json' \
  -H 'Cookie: your-session-cookie' \
  -d '{
    "period": "monthly",
    "baseDate": "2025-10-03"
  }'
```

é æœŸå›æ‡‰ï¼š
```json
{
  "success": true,
  "data": {
    "period": "monthly",
    "dateRange": {
      "start": "2025-10-01",
      "end": "2025-10-31"
    },
    "dataSource": "supabase",
    "summaryMetrics": { ... },
    "calculationDetail": {
      "step1_baseVariables": { ... },
      "step2_intermediateCalculations": { ... },
      "step3_formulaContext": { ... },
      "step4_kpiCalculations": [ ... ]
    },
    "warnings": [ ... ]
  }
}
```

#### æ¸¬è©¦ Metric Config API

```bash
curl -X GET http://localhost:5000/api/report-metrics/config \
  -H 'Cookie: your-session-cookie'
```

---

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. é€æ˜åŒ–è¨ˆç®—éç¨‹
æ¯å€‹ KPI éƒ½é¡¯ç¤ºï¼š
- ğŸ“ åŸå§‹å…¬å¼
- ğŸ”¢ ä»£å…¥çš„è®Šæ•¸å€¼
- ğŸ§® å¯¦éš›è¨ˆç®—éç¨‹
- âœ… æœ€çµ‚çµæœ
- âš ï¸ è­¦å‘Šè¨Šæ¯ï¼ˆå¦‚æœ‰ï¼‰

### 2. å››æ­¥é©Ÿè¨ˆç®—æµç¨‹
1. **åŸºç¤è®Šæ•¸èƒå–** - å¾åŸå§‹è³‡æ–™å–å¾—æœ€åŸºæœ¬çš„æ•¸å€¼
2. **ä¸­é–“è¨ˆç®—** - è¤‡é›œçš„è¡ç”Ÿè¨ˆç®—ï¼ˆå¹³å‡å€¼ã€ç¸½å’Œç­‰ï¼‰
3. **å…¬å¼ Context æº–å‚™** - çµ„è£æ‰€æœ‰å¯ç”¨è®Šæ•¸
4. **KPI è¨ˆç®—** - ä½¿ç”¨ Formula Engine è¨ˆç®—æœ€çµ‚çµæœ

### 3. è³‡æ–™ä¾†æºæ•´åˆ
- ğŸ¯ **Supabase å„ªå…ˆ** - åŒæ­¥çš„å³æ™‚è³‡æ–™
- ğŸ”„ **Storage Fallback** - æœ¬åœ° SQLite å‚™æ´
- ğŸ“Š **ç‹€æ…‹é¡¯ç¤º** - æ˜ç¢ºæ¨™ç¤ºä½¿ç”¨çš„è³‡æ–™ä¾†æº

### 4. éŒ¯èª¤è™•ç†èˆ‡è­¦å‘Š
- âœ… è‡ªå‹•ä¿®æ­£ç•°å¸¸æ•¸å€¼ï¼ˆå¦‚è² æ•¸ï¼‰
- âš ï¸ æ”¶é›†ä¸¦é¡¯ç¤ºæ‰€æœ‰è­¦å‘Š
- ğŸ” è©³ç´°çš„è¨ˆç®—éç¨‹é™¤éŒ¯è³‡è¨Š

---

## ğŸ“ æª”æ¡ˆæ¸…å–®

### å¾Œç«¯æ–°å¢/ä¿®æ”¹
- âœ… `server/services/kpi-calculator.ts` (é‡æ§‹)
- âœ… `server/services/reporting/formula-engine.ts` (æ–°å¢ method)
- âœ… `server/services/reporting/total-report-service.ts` (é©é…)
- âœ… `server/routes.ts` (æ–°å¢ API)

### å‰ç«¯æ–°å¢/ä¿®æ”¹
- âœ… `client/src/pages/dashboard-kpi-calculator.tsx` (æ–°å»º)
- âœ… `client/src/pages/dashboard.tsx` (æ•´åˆ)
- âœ… `client/src/pages/dashboard-total-report.tsx` (å·²æœ‰ Supabase ç‹€æ…‹)

---

## ğŸš€ æœªä¾†æ”¹é€²å»ºè­°

1. **å…¬å¼ç·¨è¼¯å™¨**
   - åœ¨ KPI Calculator é é¢ä¸­ç›´æ¥ç·¨è¼¯å…¬å¼
   - å³æ™‚é è¦½è¨ˆç®—çµæœ

2. **æ­·å²è¨˜éŒ„æ¯”è¼ƒ**
   - æ¯”è¼ƒä¸åŒæ™‚æœŸçš„ KPI è¨ˆç®—çµæœ
   - è¦–è¦ºåŒ–è¶¨å‹¢è®ŠåŒ–

3. **å°å‡ºåŠŸèƒ½**
   - å°å‡ºè¨ˆç®—éç¨‹ç‚º PDF/Excel
   - ç”¨æ–¼å ±å‘Šå’Œç¨½æ ¸

4. **æ•ˆèƒ½å„ªåŒ–**
   - å¿«å–è¨ˆç®—çµæœ
   - åªåœ¨è³‡æ–™è®Šæ›´æ™‚é‡æ–°è¨ˆç®—

---

## âœ… åŠŸèƒ½æª¢æŸ¥æ¸…å–®

- [x] é‡æ§‹ KPI Calculator å›å‚³å®Œæ•´è¨ˆç®—éç¨‹
- [x] æ“´å…… Formula Engine æ”¯æ´ debug æ¨¡å¼
- [x] æ›´æ–° Total Report Service é©é…æ–°æ ¼å¼
- [x] æ–°å¢ `/api/kpi-calculator/detail` API
- [x] ç¢ºèª `/api/report-metrics/config` API å®Œæ•´
- [x] å»ºç«‹ KPI Calculator Dashboard é é¢
- [x] æ•´åˆåˆ°ä¸» Dashboard
- [x] Total Report é¡¯ç¤º Supabase ç‹€æ…‹
- [x] Build æ¸¬è©¦é€šé
- [x] TypeScript é¡å‹æª¢æŸ¥é€šé

---

## ğŸ“ ç¸½çµ

æ‰€æœ‰åŠŸèƒ½å·²å®Œæˆä¸¦æ•´åˆï¼ç³»çµ±ç¾åœ¨æä¾›ï¼š

1. âœ… **é€æ˜çš„ KPI è¨ˆç®—éç¨‹** - ä½¿ç”¨è€…å¯ä»¥ç†è§£æ¯å€‹æ•¸å­—å¦‚ä½•ç”¢ç”Ÿ
2. âœ… **å®Œæ•´çš„é™¤éŒ¯è³‡è¨Š** - AI æˆ–é–‹ç™¼è€…å¯ä»¥å¿«é€Ÿå®šä½å•é¡Œ
3. âœ… **Supabase æ•´åˆ** - çœŸå¯¦è³‡æ–™åŒæ­¥èˆ‡é¡¯ç¤º
4. âœ… **å„ªé›…çš„ UI** - æ¸…æ™°çš„å››æ­¥é©Ÿå±•ç¤ºå’Œè¦–è¦ºåŒ–

ğŸ‰ **ç³»çµ±å·²ç¶“æº–å‚™å¥½æ¥å—å¯¦éš›ä½¿ç”¨å’Œé€²ä¸€æ­¥å„ªåŒ–ï¼**
