# 薪資試算系統 - 完整規劃

## 📊 系統架構圖

```
┌─────────────────────────────────────────────────────────────────┐
│                      薪資試算系統首頁                             │
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ 📊 個人試算   │  │ ⚙️  規則設定  │  │ 📑 歷史記錄   │         │
│  │              │  │  (管理員)     │  │              │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🎯 功能一：個人薪資試算

### 使用流程圖

```
┌─────────────────────────────────────────────────────────────────┐
│                     個人薪資試算頁面                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  🔍 篩選條件                                                     │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  員工姓名: [下拉選單 ▼]          身份: [全部 ▼]          │    │
│  │  開始日期: [📅 2025-11-01]      結束日期: [📅 2025-11-30] │    │
│  │                                                          │    │
│  │             [🔍 開始試算]  [📥 匯出報表]                 │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                 │
│  📊 薪資試算結果                                                 │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  Orange 的薪資試算 (2025-11)                             │    │
│  ├────────────────────────────────────────────────────────┤    │
│  │                                                          │    │
│  │  💰 總薪資: NT$ 125,450                                  │    │
│  │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━                │    │
│  │                                                          │    │
│  │  📌 教練收入 (5277 筆記錄)                                │    │
│  │     • 高音終極方程式: 1200 堂 × $50 = NT$ 60,000         │    │
│  │     • 頂歌計畫: 300 堂 × $80 = NT$ 24,000                │    │
│  │     • 高階一對一: 180 堂 × $200 = NT$ 36,000             │    │
│  │     • 其他課程: 97 堂 × $55 = NT$ 5,335                  │    │
│  │     ────────────────────────────                         │    │
│  │     小計: NT$ 125,335                                    │    │
│  │                                                          │    │
│  │  📌 業績獎金 (Closer) - 0 筆                              │    │
│  │     無業績記錄                                            │    │
│  │                                                          │    │
│  │  📌 電訪獎金 (Setter) - 0 筆                              │    │
│  │     無電訪記錄                                            │    │
│  │                                                          │    │
│  │  💡 調整項目                                              │    │
│  │     • 遲到扣款: - NT$ 0                                   │    │
│  │     • 績效獎金: + NT$ 115                                 │    │
│  │                                                          │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                 │
│  📋 明細列表                                                     │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  日期       │ 項目              │ 數量  │ 單價  │ 小計    │    │
│  ├────────────────────────────────────────────────────────┤    │
│  │ 2025-11-24 │ 高音終極方程式    │  1   │ $50   │ $50     │    │
│  │ 2025-11-24 │ 不指定一對一      │  1   │ $200  │ $200    │    │
│  │ 2025-11-23 │ 頂歌計畫          │  1   │ $80   │ $80     │    │
│  │ ...        │ ...               │ ...  │ ...   │ ...     │    │
│  │                                                          │    │
│  │              [← 上一頁]  1 / 45  [下一頁 →]              │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## ⚙️ 功能二：薪資規則設定 (管理員專用)

### 使用流程圖

```
┌─────────────────────────────────────────────────────────────────┐
│                   薪資規則設定頁面 (管理員)                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  👥 角色列表                                                     │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  [教練角色]  [業績人員]  [電訪人員]  [+ 新增角色]        │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                 │
│  📝 教練薪資規則                                                 │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  基本設定                                                 │    │
│  │  • 固定底薪: [ NT$ 0      ] (選填)                       │    │
│  │  • 計算方式: [◉ 按課程抽成  ○ 固定金額  ○ 階梯獎金]      │    │
│  │                                                          │    │
│  │  課程抽成設定                                             │    │
│  │  ┌──────────────────────────────────────────────┐      │    │
│  │  │ 課程名稱               │ 抽成金額  │ 抽成比例 │ 操作 │      │    │
│  │  ├──────────────────────────────────────────────┤      │    │
│  │  │ 高音終極方程式         │ $50      │ 10%     │ [編輯]│      │    │
│  │  │ 頂歌計畫               │ $80      │ 15%     │ [編輯]│      │    │
│  │  │ 高階一對一訓練         │ $200     │ 20%     │ [編輯]│      │    │
│  │  │ 團體教練課程           │ $150     │ 18%     │ [編輯]│      │    │
│  │  │ 預設 (未分類課程)       │ $55      │ 12%     │ [編輯]│      │    │
│  │  │                                              │      │    │
│  │  │           [+ 新增課程抽成規則]                │      │    │
│  │  └──────────────────────────────────────────────┘      │    │
│  │                                                          │    │
│  │  進階設定                                                 │    │
│  │  • 月度目標業績: [ NT$ 100,000 ]                         │    │
│  │  • 達標獎金: [ NT$ 5,000 ]                               │    │
│  │  • 超標額外抽成: [ 5% ]                                   │    │
│  │                                                          │    │
│  │            [💾 儲存規則]  [🔄 重設]                       │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                 │
│  📝 業績人員 (Closer) 薪資規則                                   │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  • 固定底薪: [ NT$ 35,000 ]                              │    │
│  │  • 業績抽成: [ 8% ]                                       │    │
│  │  • 階梯獎金:                                              │    │
│  │    - 月業績 ≥ $150,000: 額外 + $3,000                    │    │
│  │    - 月業績 ≥ $300,000: 額外 + $8,000                    │    │
│  │                                                          │    │
│  │            [💾 儲存規則]  [🔄 重設]                       │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                 │
│  📝 電訪人員 (Setter) 薪資規則                                   │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  • 固定底薪: [ NT$ 32,000 ]                              │    │
│  │  • 成交獎金: [ NT$ 500 ] / 單                             │    │
│  │  • 月度KPI獎金:                                           │    │
│  │    - 成交 ≥ 20 單: + $2,000                              │    │
│  │    - 成交 ≥ 35 單: + $5,000                              │    │
│  │                                                          │    │
│  │            [💾 儲存規則]  [🔄 重設]                       │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📑 功能三：歷史薪資記錄

### 使用流程圖

```
┌─────────────────────────────────────────────────────────────────┐
│                     歷史薪資記錄頁面                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  🔍 篩選                                                         │
│  員工: [全部 ▼]    月份: [2025-11 ▼]    狀態: [全部 ▼]          │
│                                                                 │
│  📊 薪資總覽卡片                                                 │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐          │
│  │ 本月總薪資    │ │ 已發放人數    │ │ 待確認人數    │          │
│  │ NT$ 450,000  │ │    12 人     │ │    3 人      │          │
│  └──────────────┘ └──────────────┘ └──────────────┘          │
│                                                                 │
│  📋 薪資記錄列表                                                 │
│  ┌────────────────────────────────────────────────────────┐    │
│  │ 姓名   │ 角色  │ 期間      │ 總薪資      │ 狀態    │ 操作  │    │
│  ├────────────────────────────────────────────────────────┤    │
│  │ Orange │ 教練  │ 2025-11  │ NT$ 125,450 │ ✅已確認│ [查看]│    │
│  │ Elena  │ 教練  │ 2025-11  │ NT$ 45,800  │ ✅已確認│ [查看]│    │
│  │ 47     │ Closer│ 2025-11  │ NT$ 89,200  │ ⏳待確認│ [編輯]│    │
│  │ Vivi   │ Setter│ 2025-11  │ NT$ 52,500  │ ⏳待確認│ [編輯]│    │
│  │ Vicky  │ 教練  │ 2025-11  │ NT$ 38,900  │ ✅已確認│ [查看]│    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                 │
│  操作按鈕                                                        │
│  [📥 匯出所有薪資]  [✅ 批次確認]  [📧 發送薪資通知]             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔧 功能四：薪資明細彈窗 (點擊「查看」時)

```
┌─────────────────────────────────────────────────────────────────┐
│  Orange 的薪資明細 - 2025年11月                       [✕ 關閉]   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  💰 總薪資: NT$ 125,450                                          │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━                   │
│                                                                 │
│  📊 收入明細                                                     │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  項目類別            │ 數量    │ 單價   │ 小計         │    │
│  ├────────────────────────────────────────────────────────┤    │
│  │  高音終極方程式      │ 1,200  │ $50    │ NT$ 60,000  │    │
│  │  頂歌計畫            │ 300    │ $80    │ NT$ 24,000  │    │
│  │  高階一對一訓練      │ 180    │ $200   │ NT$ 36,000  │    │
│  │  其他課程            │ 97     │ $55    │ NT$ 5,335   │    │
│  │                                                          │    │
│  │  小計                                   NT$ 125,335     │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                 │
│  💡 調整項目                                                     │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  • 績效獎金: + NT$ 115                                   │    │
│  │  • 遲到扣款: - NT$ 0                                     │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                 │
│  📝 備註                                                         │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  本月表現優異,超過目標業績 120%                           │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                 │
│  操作                                                            │
│  [📥 匯出PDF]  [✏️ 編輯調整]  [✅ 確認發放]                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📱 操作流程圖 (使用者視角)

### 員工使用流程

```
開始
  ↓
登入系統
  ↓
進入「薪資試算」頁面
  ↓
選擇月份 (如: 2025-11)
  ↓
點擊「開始試算」
  ↓
查看薪資結果
  │
  ├─→ 查看明細列表
  ├─→ 匯出 PDF 報表
  └─→ 查看歷史記錄
```

### 管理員使用流程

```
開始
  ↓
登入系統 (管理員權限)
  ↓
進入「薪資規則設定」
  ↓
選擇角色類型 (教練/Closer/Setter)
  ↓
設定薪資規則
  │
  ├─→ 固定底薪
  ├─→ 課程抽成
  ├─→ 階梯獎金
  └─→ 特殊調整
  ↓
儲存規則
  ↓
批次計算所有員工薪資
  ↓
查看/調整/確認
  ↓
匯出薪資報表
  ↓
發送通知
```

---

## 🗂️ 資料庫設計

### 新增資料表

#### 1. `salary_rules` (薪資規則表)

```sql
CREATE TABLE salary_rules (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  role_type VARCHAR(50) NOT NULL,     -- 'teacher', 'closer', 'setter'
  rule_name VARCHAR(255) NOT NULL,
  base_salary DECIMAL(15,2),          -- 固定底薪
  calculation_type VARCHAR(50),        -- 'commission', 'fixed', 'tiered'
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 2. `salary_commission_rules` (抽成規則表)

```sql
CREATE TABLE salary_commission_rules (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  salary_rule_id UUID REFERENCES salary_rules(id),
  income_item VARCHAR(255),            -- 收入項目名稱 (如: "高音終極方程式")
  commission_amount DECIMAL(15,2),     -- 固定抽成金額 (如: $50)
  commission_percentage DECIMAL(5,2),  -- 抽成比例 (如: 10%)
  priority INTEGER DEFAULT 0,          -- 優先級 (用於匹配順序)
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### 3. `salary_calculations` (薪資計算記錄表)

```sql
CREATE TABLE salary_calculations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  employee_name VARCHAR(255) NOT NULL,
  role_type VARCHAR(50),
  period_start DATE NOT NULL,
  period_end DATE NOT NULL,
  base_salary DECIMAL(15,2),
  commission_total DECIMAL(15,2),
  bonus_total DECIMAL(15,2),
  deduction_total DECIMAL(15,2),
  total_salary DECIMAL(15,2),
  status VARCHAR(50) DEFAULT 'pending',  -- 'pending', 'confirmed', 'paid'
  details JSONB,                         -- 詳細計算過程 (JSON)
  notes TEXT,
  confirmed_by VARCHAR(255),
  confirmed_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 4. `salary_adjustments` (薪資調整表)

```sql
CREATE TABLE salary_adjustments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  salary_calculation_id UUID REFERENCES salary_calculations(id),
  adjustment_type VARCHAR(50),         -- 'bonus', 'deduction'
  amount DECIMAL(15,2),
  reason TEXT,
  created_by VARCHAR(255),
  created_at TIMESTAMP DEFAULT NOW()
);
```

---

## 🎨 UI 元件規劃

### 主要元件

1. **SalaryCalculatorPage** - 主頁面
2. **SalaryRulesSettings** - 規則設定頁
3. **SalaryHistoryPage** - 歷史記錄頁
4. **SalaryDetailDialog** - 明細彈窗
5. **CommissionRuleEditor** - 抽成規則編輯器
6. **SalaryExportButton** - 匯出按鈕

### 共用元件

- **DateRangePicker** - 日期範圍選擇器
- **EmployeeSelector** - 員工選擇器
- **SalaryCard** - 薪資卡片
- **SalaryTable** - 薪資表格

---

## 🚀 開發順序

### Phase 1: 資料庫與 API (2-3天)
1. ✅ 建立資料表 migration
2. ✅ 建立薪資規則 CRUD API
3. ✅ 建立薪資計算邏輯
4. ✅ 測試計算準確性

### Phase 2: 規則設定介面 (2天)
1. ✅ 建立規則設定頁面
2. ✅ 課程抽成規則編輯器
3. ✅ 階梯獎金設定

### Phase 3: 薪資試算介面 (2-3天)
1. ✅ 個人薪資試算頁面
2. ✅ 薪資明細展示
3. ✅ 明細列表

### Phase 4: 歷史記錄與匯出 (1-2天)
1. ✅ 歷史記錄查詢
2. ✅ PDF 匯出功能
3. ✅ Excel 匯出功能

### Phase 5: 測試與優化 (1天)
1. ✅ 端對端測試
2. ✅ 效能優化
3. ✅ 權限控制

---

## 💡 建議與注意事項

### 薪資計算邏輯

1. **教練薪資**
   - 根據 `income_expense_records` 的 `teacher_name` 匹配
   - 根據 `income_item` 找到對應的抽成規則
   - 計算: `SUM(quantity × commission_amount)`

2. **業績人員薪資 (Closer)**
   - 根據 `closer` 欄位匹配
   - 計算業績總額: `SUM(amount_twd)`
   - 套用抽成比例或階梯獎金

3. **電訪人員薪資 (Setter)**
   - 根據 `setter` 欄位匹配
   - 計算成交單數: `COUNT(*)`
   - 固定底薪 + 單筆獎金 + KPI 達標獎金

### 權限控制

- **員工**: 只能查看自己的薪資
- **管理員**: 可查看所有人薪資 + 設定規則

### 資料安全

- 薪資資料加密儲存
- 操作記錄留存 (audit log)
- 敏感資料脫敏顯示

---

**準備好開始開發了嗎？** 🚀
