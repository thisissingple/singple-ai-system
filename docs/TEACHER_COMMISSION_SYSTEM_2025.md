# 新師分潤制度 (2025 年 1 月上線)

> 更新日期：2025-12-01
> 狀態：規劃完成，待 2025 年 1 月實作

---

## 完整分潤架構圖

```
學生購買課程 $150,000
         │
         ▼
┌─────────────────────────────────────────────────────────────────┐
│                     誰成交的？(closer)                          │
└─────────────────────────────────────────────────────────────────┘
         │                                    │
         ▼                                    ▼
┌─────────────────────┐            ┌─────────────────────┐
│   老師自己成交       │            │   諮詢師成交         │
│   (closer = 老師)   │            │   (closer = 諮詢師)  │
│   包含：老師兼諮詢師  │            │   (非老師本人)       │
└─────────────────────┘            └─────────────────────┘
         │                                    │
         ▼                                    ▼
┌─────────────────────┐            ┌─────────────────────┐
│ 老師銷售獎金 8%      │            │ 諮詢師抽成 8.8%      │
│ = $12,000          │            │ = $13,200           │
│ (當月發放給老師)     │            │ (當月發放給諮詢師)    │
└─────────────────────┘            └─────────────────────┘
         │                                    │
         ▼                                    ▼
┌─────────────────────┐            ┌─────────────────────┐
│ 教學分潤（老師）     │            │ 教學分潤（老師）     │
│ $770/卡 × 37       │            │ $654/卡 × 37       │
│ = $28,490          │            │ = $24,198          │
└─────────────────────┘            └─────────────────────┘
         │                                    │
         └──────────────┬─────────────────────┘
                        ▼
         ┌─────────────────────────────────────┐
         │       模組完成獎勵（老師，都一樣）    │
         │                                     │
         │  軌道完成 (9張)  → +$1,000          │
         │  支點完成 (20張) → +$1,500          │
         │  氣息完成 (37張) → +$2,000          │
         │                                     │
         │  總計：+$4,500                      │
         └─────────────────────────────────────┘
```

---

## 關鍵規則

```
┌─────────────────────────────────────────────────────────────┐
│ 規則：closer 決定一切                                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 1. closer = 老師本人（不管他有沒有諮詢師身份）                │
│    → 老師拿 8% 銷售獎金 + $770/卡 教學分潤                   │
│    → 諮詢師抽成 = $0                                        │
│                                                             │
│ 2. closer = 其他諮詢師                                      │
│    → 諮詢師拿 8.8% 抽成                                     │
│    → 老師拿 $654/卡 教學分潤（他人成交價值）                  │
│                                                             │
│ 3. 模組獎勵：不管誰成交，都是教學老師拿                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 金額對照表

### 按購買方案 + 成交方式

| 購買方案 | 成交者 | 銷售獎金(老師) | 諮詢師抽成 | 教學分潤(老師) | 模組獎勵(老師) | 老師總計 | 諮詢師總計 |
|---------|--------|--------------|----------|--------------|--------------|---------|-----------|
| 1/3 ($65k) | 老師 | $5,200 | $0 | $6,930 | $1,000 | **$13,130** | $0 |
| 1/3 ($65k) | 諮詢師 | $0 | $5,720 | $5,886 | $1,000 | **$6,886** | **$5,720** |
| 2/3 ($115k) | 老師 | $9,200 | $0 | $15,400 | $2,500 | **$27,100** | $0 |
| 2/3 ($115k) | 諮詢師 | $0 | $10,120 | $13,080 | $2,500 | **$15,580** | **$10,120** |
| 3/3 ($150k) | 老師 | $12,000 | $0 | $28,490 | $4,500 | **$44,990** | $0 |
| 3/3 ($150k) | 諮詢師 | $0 | $13,200 | $24,198 | $4,500 | **$28,698** | **$13,200** |

### 公司支出對照

| 成交方式 | 老師收入 | 諮詢師收入 | 公司總支出 | 佔比 |
|---------|---------|-----------|-----------|------|
| 老師自己成交 | $44,990 | $0 | $44,990 | 30.0% |
| 諮詢師成交 | $28,698 | $13,200 | $41,898 | 27.9% |

---

## 分潤組成說明

### 1. 銷售獎金 (Sales Bonus)
- **適用對象**：僅限老師自己成交（closer = 老師本人）
- **計算方式**：購買金額 × 8%
- **發放時機**：購買當月

| 購買方案 | 金額 | 銷售獎金 |
|---------|------|---------|
| 1/3 課程 | $65,000 | $5,200 |
| 2/3 課程 | $115,000 | $9,200 |
| 3/3 完整課程 | $150,000 | $12,000 |

### 2. 諮詢師抽成 (Consultant Commission)
- **適用對象**：諮詢師成交（closer = 諮詢師，且非老師本人）
- **計算方式**：購買金額 × 8.8%
- **發放時機**：購買當月

### 3. 教學分潤 (Teaching Commission)
- **計算方式**：固定每張卡片價值
- **自己成交**：$770/卡 (總計 $28,490 for 37 cards)
- **他人成交**：$654/卡 (總計 $24,198 for 37 cards)
- **發放時機**：每月結算，當月上了幾張就算幾張

### 4. 模組完成獎勵 (Module Completion Bonus)
- **適用對象**：教學老師（不論誰成交）
- **觸發條件**：學生完成該模組所有卡片
- **發放時機**：完成當月

| 模組 | 累計卡片數 | 獎勵金額 |
|------|-----------|---------|
| 軌道 (Track) | 9 | $1,000 |
| 支點 (Pivot) | 20 | $1,500 |
| 氣息 (Breath) | 37 | $2,000 |
| **總計** | | **$4,500** |

---

## 邊界情況處理

### 1. 成交判定
- 以 `closer` 欄位為準
- 有爭議時由營運主管手動覆寫

### 2. 學生換老師
- 卡片分潤：誰教的算誰的
- 模組獎勵：給教完該模組「最後一張卡」的老師

### 3. 退費處理
- 7 天內：追回銷售獎金/諮詢師抽成
- 7 天後：不追回
- 已教課程分潤：不追回

### 4. 升級補差額
- 補繳金額 × 8% 給成交者（銷售獎金或諮詢師抽成）

### 5. 新舊制度交接
- 以「教學日期」判斷
- 2025/01/01 後的課用新制

---

## 技術實作計畫

### Phase 1: 資料庫變更

#### 1.1 新增資料表：`teacher_course_progress`
```sql
CREATE TABLE teacher_course_progress (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  teacher_id UUID REFERENCES users(id),
  student_email TEXT NOT NULL,
  cards_completed INTEGER DEFAULT 0,
  track_completed BOOLEAN DEFAULT FALSE,
  pivot_completed BOOLEAN DEFAULT FALSE,
  breath_completed BOOLEAN DEFAULT FALSE,
  is_self_closed BOOLEAN DEFAULT FALSE,
  purchase_amount NUMERIC(12,2),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 1.2 修改 `employee_salary_settings`
```sql
ALTER TABLE employee_salary_settings ADD COLUMN IF NOT EXISTS
  card_value_self_closed NUMERIC(8,2) DEFAULT 770,
  card_value_other_closed NUMERIC(8,2) DEFAULT 654,
  sales_bonus_rate NUMERIC(4,2) DEFAULT 0.08,
  track_bonus NUMERIC(8,2) DEFAULT 1000,
  pivot_bonus NUMERIC(8,2) DEFAULT 1500,
  breath_bonus NUMERIC(8,2) DEFAULT 2000;
```

### Phase 2: 後端服務修改

修改 `salary-calculator-service.ts`：
- 新增 `calculateTeachingCommission()` - 計算教學分潤
- 新增 `calculateModuleBonuses()` - 計算模組完成獎勵
- 新增 `calculateSalesBonus()` - 計算銷售獎金
- 修改 `calculateSalary()` - 整合新邏輯

### Phase 3: 前端修改

- 薪資計算頁面：顯示新的分潤結構
- 員工設定頁面：新增分潤率設定區塊
- 進度追蹤介面：顯示卡片完成進度

### Phase 4: Trello 整合（後續）

- 自動追蹤卡片完成
- 定期同步 Trello 看板與資料庫

---

## 關鍵檔案

| 檔案 | 修改內容 |
|------|---------|
| `server/services/salary-calculator-service.ts` | 核心分潤計算邏輯 |
| `server/routes.ts` | 新增 API 端點 |
| `client/src/pages/salary/salary-calculator.tsx` | 薪資計算 UI |
| `client/src/pages/settings/employees.tsx` | 員工設定 UI |
| `supabase/migrations/081_*.sql` | 資料庫 migration |
