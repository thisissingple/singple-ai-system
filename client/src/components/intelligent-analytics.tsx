import { useState, useEffect } from 'react';
import { useQuery } from '@tanstack/react-query';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import {
  BarChart3,
  TrendingUp,
  Users,
  DollarSign,
  Activity,
  RefreshCw,
  Sparkles,
  Target,
  CheckCircle,
  Grid
} from 'lucide-react';
import { apiRequest } from '@/lib/queryClient';

interface WorksheetMeta {
  id: string;
  worksheetName: string;
  headers: string[];
  rowCount: number;
  isEnabled: boolean;
  spreadsheetId: string;
}

interface SheetRecord {
  id: string;
  data: Record<string, any>;
  rowIndex: number;
  worksheetId: string;
}

interface IntelligentKPI {
  id: string;
  name: string;
  value: number | string;
  calculation: string;
  category: 'conversion' | 'financial' | 'activity' | 'status';
  icon: any;
  color: string;
  description: string;
}

interface DataRelationship {
  sourceTable: string;
  targetTable: string;
  keyField: string;
  confidence: number;
  description: string;
}

interface AutoGeneratedTable {
  id: string;
  name: string;
  description: string;
  type: 'summary' | 'pivot' | 'analytics' | 'comparison';
  headers: string[];
  rows: any[][];
  insights: string[];
  sourceWorksheets: string[];
}

export function IntelligentAnalytics() {
  const [kpis, setKpis] = useState<IntelligentKPI[]>([]);
  const [relationships, setRelationships] = useState<DataRelationship[]>([]);
  const [analysisStatus, setAnalysisStatus] = useState<'idle' | 'analyzing' | 'completed' | 'error'>('idle');
  const [currentWorksheets, setCurrentWorksheets] = useState<WorksheetMeta[]>([]);
  const [generatedTables, setGeneratedTables] = useState<AutoGeneratedTable[]>([]);
  const [tableGenerationStatus, setTableGenerationStatus] = useState<'idle' | 'generating' | 'completed' | 'error'>('idle');

  // ç²å–çœŸå¯¦å·¥ä½œè¡¨æ•¸æ“š
  const fetchWorksheetData = async (worksheetId: string): Promise<SheetRecord[]> => {
    try {
      return await apiRequest<SheetRecord[]>('GET', `/api/worksheets/${worksheetId}/data`);
    } catch (error) {
      console.error(`Error fetching data for worksheet ${worksheetId}:`, error);
      return [];
    }
  };

  // ç²å–çœŸå¯¦å·¥ä½œè¡¨åˆ—è¡¨
  const { data: worksheets = [], isLoading: worksheetsLoading } = useQuery<WorksheetMeta[]>({
    queryKey: ['/api/worksheets'],
    enabled: true
  });

  // AI æ™ºèƒ½åˆ†æå‡½æ•¸
  const performIntelligentAnalysis = async () => {
    setAnalysisStatus('analyzing');
    
    try {
      // æ­¥é©Ÿ1: è­˜åˆ¥å·¥ä½œè¡¨é¡å‹å’Œé—œä¿‚
      const detectedRelationships = analyzeDataRelationships(worksheets);
      setRelationships(detectedRelationships);

      // æ­¥é©Ÿ2: æ ¹æ“šä½ çš„éœ€æ±‚è‡ªå‹•è¨ˆç®— KPI
      const calculatedKPIs = await calculateIntelligentKPIs(worksheets);
      setKpis(calculatedKPIs);

      setAnalysisStatus('completed');
    } catch (error) {
      console.error('Intelligence analysis failed:', error);
      setAnalysisStatus('error');
    }
  };

  // åˆ†ææ•¸æ“šé—œä¿‚
  const analyzeDataRelationships = (sheets: WorksheetMeta[]): DataRelationship[] => {
    const relationships: DataRelationship[] = [];

    // åŸºæ–¼ä½ çš„éœ€æ±‚ï¼Œè‡ªå‹•è­˜åˆ¥é—œä¿‚ï¼š
    // 1. æ‰“å¡è¨˜éŒ„è¡¨ <-> è³¼è²·è¨˜éŒ„è¡¨ (é€šéå§“å/é›»è©±)
    const experienceSheet = sheets.find(s => s.worksheetName.includes('é«”é©—èª²ä¸Šèª²è¨˜éŒ„') || s.worksheetName.includes('æ‰“å¡è¨˜éŒ„'));
    const purchaseSheet = sheets.find(s => s.worksheetName.includes('è³¼è²·è¨˜éŒ„'));
    const consultationSheet = sheets.find(s => s.worksheetName.includes('è«®è©¢æˆäº¤'));

    if (experienceSheet && purchaseSheet) {
      relationships.push({
        sourceTable: experienceSheet.worksheetName,
        targetTable: purchaseSheet.worksheetName,
        keyField: 'å§“å/é›»è©±',
        confidence: 0.95,
        description: 'é€šéå­¸ç”Ÿå§“åå’Œé›»è©±é—œè¯é«”é©—èª²è¨˜éŒ„èˆ‡è³¼è²·è¨˜éŒ„'
      });
    }

    if (consultationSheet && purchaseSheet) {
      relationships.push({
        sourceTable: consultationSheet.worksheetName,
        targetTable: purchaseSheet.worksheetName,
        keyField: 'email',
        confidence: 0.90,
        description: 'é€šé email é—œè¯è«®è©¢æˆäº¤è¡¨èˆ‡è³¼è²·è¨˜éŒ„è¡¨'
      });
    }

    return relationships;
  };

  // æ™ºèƒ½è¨ˆç®— KPIï¼ˆåŸºæ–¼çœŸå¯¦æ•¸æ“šï¼‰
  const calculateIntelligentKPIs = async (sheets: WorksheetMeta[]): Promise<IntelligentKPI[]> => {
    const kpis: IntelligentKPI[] = [];

    try {
      // ç²å–é«”é©—èª²è¨˜éŒ„è¡¨æ•¸æ“š
      const experienceSheet = sheets.find(s => 
        s.worksheetName.includes('é«”é©—èª²') || 
        s.worksheetName.includes('æ‰“å¡è¨˜éŒ„') ||
        s.worksheetName.includes('ä¸Šèª²è¨˜éŒ„')
      );
      
      // ç²å–è³¼è²·è¨˜éŒ„è¡¨æ•¸æ“š
      const purchaseSheet = sheets.find(s => 
        s.worksheetName.includes('è³¼è²·è¨˜éŒ„')
      );

      let experienceData: SheetRecord[] = [];
      let purchaseData: SheetRecord[] = [];

      if (experienceSheet) {
        experienceData = await fetchWorksheetData(experienceSheet.id);
      }
      
      if (purchaseSheet) {
        purchaseData = await fetchWorksheetData(purchaseSheet.id);
      }

      // KPI 1: å·²æˆäº¤æ•¸ = ç‹€æ…‹æ¬„åŒ…å«"å·²è½‰é«˜"çš„ç¸½æ•¸
      if (experienceData.length > 0) {
        const completedCount = experienceData.filter(record => {
          const status = record.data?.['ç‹€æ…‹'] || record.data?.['status'] || '';
          return status.toString().includes('å·²è½‰é«˜') || status.toString().includes('å·²æˆäº¤');
        }).length;
        
        kpis.push({
          id: 'completed_conversions',
          name: 'å·²æˆäº¤æ•¸',
          value: completedCount,
          calculation: 'é«”é©—èª²è¨˜éŒ„è¡¨ä¸­ã€Œç‹€æ…‹ã€åŒ…å«"å·²è½‰é«˜"çš„çµ±è¨ˆ',
          category: 'conversion',
          icon: CheckCircle,
          color: 'text-green-600',
          description: 'å·²æˆåŠŸè½‰æ›çš„å­¸ç”Ÿç¸½æ•¸'
        });
      }

      // KPI 2: é«”é©—ä¸­å­¸ç”Ÿæ•¸
      if (experienceData.length > 0) {
        const inExperienceCount = experienceData.filter(record => {
          const status = record.data?.['ç‹€æ…‹'] || record.data?.['status'] || '';
          return status.toString().includes('é«”é©—ä¸­') || status.toString().includes('é€²è¡Œä¸­');
        }).length;
        
        kpis.push({
          id: 'in_experience',
          name: 'é«”é©—ä¸­å­¸ç”Ÿæ•¸',
          value: inExperienceCount,
          calculation: 'ç‹€æ…‹åŒ…å«"é«”é©—ä¸­"æˆ–"é€²è¡Œä¸­"çš„å­¸ç”Ÿçµ±è¨ˆ',
          category: 'activity',
          icon: Activity,
          color: 'text-blue-600',
          description: 'æ­£åœ¨é«”é©—èª²ç¨‹çš„å­¸ç”Ÿæ•¸é‡'
        });
      }

      // KPI 3: æœªæˆäº¤å­¸ç”Ÿæ•¸
      if (experienceData.length > 0) {
        const notConvertedCount = experienceData.filter(record => {
          const status = record.data?.['ç‹€æ…‹'] || record.data?.['status'] || '';
          return status.toString().includes('æœªè½‰é«˜') || status.toString().includes('æœªæˆäº¤');
        }).length;
        
        kpis.push({
          id: 'not_converted',
          name: 'æœªæˆäº¤å­¸ç”Ÿæ•¸',
          value: notConvertedCount,
          calculation: 'ç‹€æ…‹åŒ…å«"æœªè½‰é«˜"æˆ–"æœªæˆäº¤"çš„å­¸ç”Ÿçµ±è¨ˆ',
          category: 'conversion',
          icon: Users,
          color: 'text-orange-600',
          description: 'å°šæœªè½‰æ›çš„å­¸ç”Ÿæ•¸é‡'
        });
      }

      // KPI 4: æœªé–‹å§‹å­¸ç”Ÿæ•¸
      if (experienceData.length > 0) {
        const notStartedCount = experienceData.filter(record => {
          const status = record.data?.['ç‹€æ…‹'] || record.data?.['status'] || '';
          return status.toString().includes('æœªé–‹å§‹') || status === '';
        }).length;
        
        kpis.push({
          id: 'not_started',
          name: 'æœªé–‹å§‹å­¸ç”Ÿæ•¸',
          value: notStartedCount,
          calculation: 'ç‹€æ…‹åŒ…å«"æœªé–‹å§‹"æˆ–ç©ºå€¼çš„å­¸ç”Ÿçµ±è¨ˆ',
          category: 'status',
          icon: Target,
          color: 'text-gray-600',
          description: 'å°šæœªé–‹å§‹é«”é©—èª²ç¨‹çš„å­¸ç”Ÿ'
        });
      }

      // KPI 5: å·²æˆäº¤é‡‘é¡ï¼ˆåŸºæ–¼è³¼è²·è¨˜éŒ„è¡¨ï¼‰
      if (purchaseData.length > 0) {
        const totalRevenue = purchaseData.reduce((sum, record) => {
          const amount = parseFloat(record.data?.['é‡‘é¡'] || record.data?.['amount'] || '0');
          return sum + (isNaN(amount) ? 0 : amount);
        }, 0);
        
        kpis.push({
          id: 'total_revenue',
          name: 'å·²æˆäº¤é‡‘é¡',
          value: `NT$ ${totalRevenue.toLocaleString()}`,
          calculation: 'è³¼è²·è¨˜éŒ„è¡¨ä¸­æ‰€æœ‰é‡‘é¡çš„åŠ ç¸½',
          category: 'financial',
          icon: DollarSign,
          color: 'text-green-700',
          description: 'å·²æˆäº¤å­¸ç”Ÿçš„ç¸½æ”¶å…¥é‡‘é¡'
        });
      }

      // å¦‚æœæ²’æœ‰æ•¸æ“šï¼Œé¡¯ç¤ºé»˜èªå€¼
      if (kpis.length === 0) {
        kpis.push({
          id: 'no_data',
          name: 'ç­‰å¾…æ•¸æ“š',
          value: 'å°šç„¡æ•¸æ“š',
          calculation: 'è«‹æª¢æŸ¥ Google Sheets åŒæ­¥ç‹€æ…‹',
          category: 'status',
          icon: Target,
          color: 'text-gray-600',
          description: 'ç³»çµ±æ­£åœ¨ç­‰å¾…å·¥ä½œè¡¨æ•¸æ“šåŒæ­¥'
        });
      }

    } catch (error) {
      console.error('Error calculating KPIs:', error);
      // éŒ¯èª¤æ™‚é¡¯ç¤ºéŒ¯èª¤ KPI
      kpis.push({
        id: 'error_state',
        name: 'è¨ˆç®—éŒ¯èª¤',
        value: 'æ•¸æ“šéŒ¯èª¤',
        calculation: 'ç„¡æ³•è¨ˆç®— KPIï¼Œè«‹æª¢æŸ¥æ•¸æ“šé€£æ¥',
        category: 'status',
        icon: Target,
        color: 'text-red-600',
        description: 'è¨ˆç®—éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤'
      });
    }

    return kpis;
  };

  // æ™ºèƒ½è¡¨æ ¼ç”ŸæˆåŠŸèƒ½
  const generateIntelligentTables = async () => {
    setTableGenerationStatus('generating');
    
    try {
      const tables: AutoGeneratedTable[] = [];
      
      // ç²å–æ‰€æœ‰å•Ÿç”¨çš„å·¥ä½œè¡¨æ•¸æ“š
      const enabledSheets = worksheets.filter(w => w.isEnabled);
      const allData: { [worksheetId: string]: SheetRecord[] } = {};
      
      for (const sheet of enabledSheets) {
        allData[sheet.id] = await fetchWorksheetData(sheet.id);
      }

      // è¡¨æ ¼ 1: å­¸ç”Ÿè½‰æ›ç‹€æ…‹æ‘˜è¦è¡¨
      const experienceSheet = worksheets.find(s => 
        s.worksheetName.includes('é«”é©—èª²') || s.worksheetName.includes('ä¸Šèª²è¨˜éŒ„')
      );
      
      if (experienceSheet && allData[experienceSheet.id]) {
        const experienceData = allData[experienceSheet.id];
        const statusSummary = experienceData.reduce((acc: any, record) => {
          const status = record.data?.['ç‹€æ…‹'] || 'æœªåˆ†é¡';
          const teacher = record.data?.['è€å¸«'] || record.data?.['æˆèª²è€å¸«'] || 'æœªæŒ‡å®š';
          
          const key = `${teacher}_${status}`;
          if (!acc[key]) {
            acc[key] = { teacher, status, count: 0, students: [] };
          }
          acc[key].count++;
          acc[key].students.push(record.data?.['å§“å'] || 'æœªçŸ¥');
          return acc;
        }, {});

        const summaryRows = Object.values(statusSummary).map((item: any) => [
          item.teacher,
          item.status,
          item.count,
          Math.round((item.count / experienceData.length) * 100) + '%'
        ]);

        tables.push({
          id: 'status_summary',
          name: 'å­¸ç”Ÿè½‰æ›ç‹€æ…‹æ‘˜è¦',
          description: 'æŒ‰è€å¸«å’Œç‹€æ…‹åˆ†çµ„çš„å­¸ç”Ÿçµ±è¨ˆ',
          type: 'summary',
          headers: ['æˆèª²è€å¸«', 'å­¸ç”Ÿç‹€æ…‹', 'å­¸ç”Ÿæ•¸é‡', 'ä½”æ¯”'],
          rows: summaryRows,
          insights: [
            `ç¸½å…± ${experienceData.length} ä½å­¸ç”Ÿ`,
            `åˆ†å¸ƒåœ¨ ${Object.keys(statusSummary).length} å€‹ä¸åŒçš„è€å¸«-ç‹€æ…‹çµ„åˆä¸­`,
            'å¯ä»¥å¹«åŠ©è­˜åˆ¥è¡¨ç¾æœ€ä½³çš„è€å¸«å’Œéœ€è¦é—œæ³¨çš„å­¸ç”Ÿç‹€æ…‹'
          ],
          sourceWorksheets: [experienceSheet.worksheetName]
        });
      }

      // è¡¨æ ¼ 2: è³¼è²·åˆ†æå°æ¯”è¡¨
      const purchaseSheet = worksheets.find(s => s.worksheetName.includes('è³¼è²·è¨˜éŒ„'));
      
      if (purchaseSheet && allData[purchaseSheet.id] && experienceSheet && allData[experienceSheet.id]) {
        const purchaseData = allData[purchaseSheet.id];
        const experienceData = allData[experienceSheet.id];
        
        // å‰µå»ºå­¸ç”Ÿè³¼è²·å°æ¯”åˆ†æ
        const studentComparison = experienceData.map(expRecord => {
          const studentName = expRecord.data?.['å§“å'] || '';
          const studentPhone = expRecord.data?.['é›»è©±'] || '';
          const studentStatus = expRecord.data?.['ç‹€æ…‹'] || '';
          
          // æŸ¥æ‰¾æ˜¯å¦æœ‰è³¼è²·è¨˜éŒ„
          const purchaseRecord = purchaseData.find(purRecord => 
            purRecord.data?.['å§“å'] === studentName || 
            purRecord.data?.['é›»è©±'] === studentPhone
          );
          
          return [
            studentName,
            studentPhone,
            studentStatus,
            purchaseRecord ? 'æ˜¯' : 'å¦',
            purchaseRecord ? (purchaseRecord.data?.['é‡‘é¡'] || '0') : '0',
            purchaseRecord ? (purchaseRecord.data?.['æ–¹æ¡ˆ'] || 'æœªçŸ¥') : '-'
          ];
        });

        tables.push({
          id: 'purchase_comparison',
          name: 'å­¸ç”Ÿè³¼è²·è½‰æ›å°æ¯”',
          description: 'é«”é©—èª²å­¸ç”Ÿèˆ‡è³¼è²·è¨˜éŒ„çš„å®Œæ•´å°æ¯”åˆ†æ',
          type: 'comparison',
          headers: ['å­¸ç”Ÿå§“å', 'è¯çµ¡é›»è©±', 'é«”é©—ç‹€æ…‹', 'æ˜¯å¦è³¼è²·', 'è³¼è²·é‡‘é¡', 'è³¼è²·æ–¹æ¡ˆ'],
          rows: studentComparison.slice(0, 20), // é™åˆ¶å‰20ç­†ä»¥é¿å…è¡¨æ ¼éå¤§
          insights: [
            `${studentComparison.filter(row => row[3] === 'æ˜¯').length} ä½å­¸ç”Ÿå·²è³¼è²·`,
            `è½‰æ›ç‡: ${Math.round((studentComparison.filter(row => row[3] === 'æ˜¯').length / studentComparison.length) * 100)}%`,
            'å¯ä»¥å¹«åŠ©è­˜åˆ¥å“ªäº›å­¸ç”Ÿå®Œæˆäº†å¾é«”é©—åˆ°è³¼è²·çš„å®Œæ•´è½‰æ›'
          ],
          sourceWorksheets: [experienceSheet.worksheetName, purchaseSheet.worksheetName]
        });
      }

      // è¡¨æ ¼ 3: æ™‚é–“è¶¨å‹¢åˆ†æè¡¨
      if (experienceSheet && allData[experienceSheet.id]) {
        const experienceData = allData[experienceSheet.id];
        const dateAnalysis = experienceData.reduce((acc: any, record) => {
          const dateStr = record.data?.['ä¸Šèª²æ—¥æœŸ'] || record.data?.['æ—¥æœŸ'] || 'æœªçŸ¥æ—¥æœŸ';
          
          if (dateStr !== 'æœªçŸ¥æ—¥æœŸ') {
            // ç°¡åŒ–æ—¥æœŸè™•ç† - æŒ‰æœˆä»½åˆ†çµ„
            const month = dateStr.substring(0, 7) || dateStr.substring(0, 6); // YYYY-MM æ ¼å¼
            if (!acc[month]) {
              acc[month] = { total: 0, completed: 0, inProgress: 0 };
            }
            acc[month].total++;
            
            const status = record.data?.['ç‹€æ…‹'] || '';
            if (status.includes('å·²è½‰é«˜') || status.includes('å·²æˆäº¤')) {
              acc[month].completed++;
            } else if (status.includes('é«”é©—ä¸­') || status.includes('é€²è¡Œä¸­')) {
              acc[month].inProgress++;
            }
          }
          return acc;
        }, {});

        const trendRows = Object.entries(dateAnalysis)
          .sort(([a], [b]) => a.localeCompare(b))
          .map(([month, data]: [string, any]) => [
            month,
            data.total,
            data.completed,
            data.inProgress,
            Math.round((data.completed / data.total) * 100) + '%'
          ]);

        tables.push({
          id: 'time_trend',
          name: 'æ™‚é–“è¶¨å‹¢åˆ†æ',
          description: 'æŒ‰æœˆä»½çµ±è¨ˆçš„å­¸ç”Ÿæ´»å‹•å’Œè½‰æ›è¶¨å‹¢',
          type: 'analytics',
          headers: ['æœˆä»½', 'ç¸½å­¸ç”Ÿæ•¸', 'å·²æˆäº¤', 'é€²è¡Œä¸­', 'æˆäº¤ç‡'],
          rows: trendRows,
          insights: [
            `åˆ†æäº† ${trendRows.length} å€‹æœˆçš„æ•¸æ“š`,
            `å¹³å‡æ¯æœˆ ${Math.round(Object.values(dateAnalysis).reduce((sum: number, data: any) => sum + data.total, 0) / trendRows.length)} ä½å­¸ç”Ÿ`,
            'å¯ä»¥å¹«åŠ©è­˜åˆ¥æ¥­å‹™çš„å­£ç¯€æ€§è¶¨å‹¢å’Œæˆé•·æ¨¡å¼'
          ],
          sourceWorksheets: [experienceSheet.worksheetName]
        });
      }

      setGeneratedTables(tables);
      setTableGenerationStatus('completed');
      
    } catch (error) {
      console.error('Error generating tables:', error);
      setTableGenerationStatus('error');
    }
  };

  useEffect(() => {
    if (worksheets.length > 0) {
      setCurrentWorksheets(worksheets);
    }
  }, [worksheets]);

  return (
    <div className="space-y-6">
      {/* æ™ºèƒ½åˆ†ææ§åˆ¶é¢æ¿ */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Sparkles className="h-5 w-5 text-purple-600" />
            AI æ™ºèƒ½æ•¸æ“šåˆ†æ
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-4">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-muted-foreground">
                  æª¢æ¸¬åˆ° {worksheets.length} å€‹å·¥ä½œè¡¨ï¼Œ
                  {worksheets.filter(w => w.isEnabled).length} å€‹å·²å•Ÿç”¨
                </p>
                <p className="text-xs text-muted-foreground mt-1">
                  ç³»çµ±å°‡è‡ªå‹•åˆ†ææ¬„ä½é—œä¿‚ä¸¦è¨ˆç®— KPI æŒ‡æ¨™
                </p>
              </div>
              <Button 
                onClick={performIntelligentAnalysis}
                disabled={analysisStatus === 'analyzing' || worksheetsLoading}
                className="gap-2"
                data-testid="auto-analyze-button"
              >
                {analysisStatus === 'analyzing' ? (
                  <RefreshCw className="h-4 w-4 animate-spin" />
                ) : (
                  <Sparkles className="h-4 w-4" />
                )}
                {analysisStatus === 'analyzing' ? 'åˆ†æä¸­...' : 'ä¸€éµè‡ªå‹•åˆ†æ'}
              </Button>
            </div>

            {/* åˆ†æç‹€æ…‹ */}
            <div className="flex items-center gap-2">
              <Badge 
                variant={analysisStatus === 'completed' ? 'default' : 
                        analysisStatus === 'analyzing' ? 'secondary' : 
                        analysisStatus === 'error' ? 'destructive' : 'outline'}
                data-testid="analysis-status-badge"
              >
                {analysisStatus === 'completed' ? 'åˆ†æå®Œæˆ' :
                 analysisStatus === 'analyzing' ? 'æ­£åœ¨åˆ†æ' :
                 analysisStatus === 'error' ? 'åˆ†æå¤±æ•—' : 'å¾…åˆ†æ'}
              </Badge>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* æª¢æ¸¬åˆ°çš„æ•¸æ“šé—œä¿‚ */}
      {relationships.length > 0 && (
        <Card>
          <CardHeader>
            <CardTitle className="text-lg">æ•¸æ“šé—œä¿‚åˆ†æ</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-3">
              {relationships.map((rel, index) => (
                <div key={index} className="flex items-center justify-between p-3 bg-muted/30 rounded-lg" data-testid={`relationship-${index}`}>
                  <div className="space-y-1">
                    <div className="font-medium">
                      {rel.sourceTable} â†” {rel.targetTable}
                    </div>
                    <div className="text-sm text-muted-foreground">
                      é—œè¯æ¬„ä½: {rel.keyField}
                    </div>
                    <div className="text-xs text-muted-foreground">
                      {rel.description}
                    </div>
                  </div>
                  <Badge variant="secondary" data-testid={`relationship-confidence-${index}`}>
                    {Math.round(rel.confidence * 100)}% ä¿¡å¿ƒåº¦
                  </Badge>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>
      )}

      {/* æ™ºèƒ½è¨ˆç®—çš„ KPI */}
      {kpis.length > 0 && (
        <div className="space-y-4">
          <h3 className="text-lg font-semibold flex items-center gap-2">
            <BarChart3 className="h-5 w-5" />
            æ™ºèƒ½ KPI æŒ‡æ¨™
          </h3>
          
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {kpis.map((kpi) => {
              const IconComponent = kpi.icon;
              return (
                <Card key={kpi.id} className="relative overflow-hidden" data-testid={`kpi-card-${kpi.id}`}>
                  <div className={`absolute inset-0 bg-gradient-to-br opacity-10 ${
                    kpi.category === 'conversion' ? 'from-green-500 to-green-600' :
                    kpi.category === 'financial' ? 'from-emerald-500 to-emerald-600' :
                    kpi.category === 'activity' ? 'from-blue-500 to-blue-600' :
                    'from-gray-500 to-gray-600'
                  }`} />
                  
                  <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                    <CardTitle className="text-sm font-medium" data-testid={`kpi-title-${kpi.id}`}>{kpi.name}</CardTitle>
                    <IconComponent className={`h-4 w-4 ${kpi.color}`} data-testid={`kpi-icon-${kpi.id}`} />
                  </CardHeader>
                  
                  <CardContent>
                    <div className={`text-2xl font-bold ${kpi.color}`} data-testid={`kpi-value-${kpi.id}`}>
                      {kpi.value}
                    </div>
                    <p className="text-xs text-muted-foreground mt-1" data-testid={`kpi-description-${kpi.id}`}>
                      {kpi.description}
                    </p>
                    <div className="mt-3 pt-3 border-t border-border/40">
                      <p className="text-xs text-muted-foreground" data-testid={`kpi-calculation-${kpi.id}`}>
                        <strong>è¨ˆç®—é‚è¼¯:</strong> {kpi.calculation}
                      </p>
                    </div>
                  </CardContent>
                </Card>
              );
            })}
          </div>
        </div>
      )}

      {/* ä¸€éµæ™ºèƒ½è¡¨æ ¼ç”Ÿæˆ */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Grid className="h-5 w-5 text-indigo-600" />
            ä¸€éµæ™ºèƒ½è¡¨æ ¼ç”Ÿæˆ
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-4">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-muted-foreground">
                  è‡ªå‹•åˆ†æå·¥ä½œè¡¨æ•¸æ“šä¸¦ç”Ÿæˆå¤šç¨®é¡å‹çš„æ™ºèƒ½è¡¨æ ¼
                </p>
                <p className="text-xs text-muted-foreground mt-1">
                  åŒ…æ‹¬è½‰æ›ç‹€æ…‹æ‘˜è¦ã€è³¼è²·å°æ¯”åˆ†æã€æ™‚é–“è¶¨å‹¢ç­‰
                </p>
              </div>
              <Button 
                onClick={generateIntelligentTables}
                disabled={tableGenerationStatus === 'generating' || worksheetsLoading || worksheets.length === 0}
                className="gap-2"
                data-testid="generate-tables-button"
              >
                {tableGenerationStatus === 'generating' ? (
                  <RefreshCw className="h-4 w-4 animate-spin" />
                ) : (
                  <Grid className="h-4 w-4" />
                )}
                {tableGenerationStatus === 'generating' ? 'ç”Ÿæˆä¸­...' : 'ä¸€éµç”Ÿæˆè¡¨æ ¼'}
              </Button>
            </div>

            {/* ç”Ÿæˆç‹€æ…‹ */}
            <div className="flex items-center gap-2">
              <Badge 
                variant={tableGenerationStatus === 'completed' ? 'default' : 
                        tableGenerationStatus === 'generating' ? 'secondary' : 
                        tableGenerationStatus === 'error' ? 'destructive' : 'outline'}
                data-testid="table-generation-status"
              >
                {tableGenerationStatus === 'completed' ? 'ç”Ÿæˆå®Œæˆ' :
                 tableGenerationStatus === 'generating' ? 'æ­£åœ¨ç”Ÿæˆ' :
                 tableGenerationStatus === 'error' ? 'ç”Ÿæˆå¤±æ•—' : 'å¾…ç”Ÿæˆ'}
              </Badge>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* è‡ªå‹•ç”Ÿæˆçš„æ™ºèƒ½è¡¨æ ¼ */}
      {generatedTables.length > 0 && (
        <div className="space-y-4">
          <h3 className="text-lg font-semibold flex items-center gap-2">
            <Grid className="h-5 w-5" />
            è‡ªå‹•ç”Ÿæˆçš„æ™ºèƒ½è¡¨æ ¼
          </h3>
          
          {generatedTables.map((table, tableIndex) => (
            <Card key={table.id} className="overflow-hidden" data-testid={`generated-table-${table.id}`}>
              <CardHeader>
                <div className="flex items-start justify-between">
                  <div className="space-y-1">
                    <CardTitle className="text-lg">{table.name}</CardTitle>
                    <p className="text-sm text-muted-foreground">{table.description}</p>
                    <div className="flex items-center gap-2 mt-2">
                      <Badge variant="outline" className="text-xs">
                        {table.type === 'summary' ? 'æ‘˜è¦è¡¨' :
                         table.type === 'pivot' ? 'äº¤å‰åˆ†æ' :
                         table.type === 'analytics' ? 'åˆ†æè¡¨' : 'å°æ¯”è¡¨'}
                      </Badge>
                      <span className="text-xs text-muted-foreground">
                        æ•¸æ“šä¾†æº: {table.sourceWorksheets.join(', ')}
                      </span>
                    </div>
                  </div>
                </div>
              </CardHeader>
              
              <CardContent>
                {/* è¡¨æ ¼å…§å®¹ */}
                <div className="overflow-x-auto mb-4">
                  <table className="w-full text-sm border-collapse border border-border">
                    <thead>
                      <tr className="bg-muted/30">
                        {table.headers.map((header, headerIndex) => (
                          <th key={headerIndex} className="border border-border p-2 text-left font-medium">
                            {header}
                          </th>
                        ))}
                      </tr>
                    </thead>
                    <tbody>
                      {table.rows.map((row, rowIndex) => (
                        <tr key={rowIndex} className="hover:bg-muted/20">
                          {row.map((cell, cellIndex) => (
                            <td key={cellIndex} className="border border-border p-2" data-testid={`table-cell-${table.id}-${rowIndex}-${cellIndex}`}>
                              {cell}
                            </td>
                          ))}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>

                {/* æ´å¯Ÿåˆ†æ */}
                <div className="space-y-2">
                  <h4 className="font-medium text-sm">ğŸ” æ•¸æ“šæ´å¯Ÿ</h4>
                  <div className="grid grid-cols-1 gap-2">
                    {table.insights.map((insight, insightIndex) => (
                      <div key={insightIndex} className="text-xs text-muted-foreground bg-muted/20 p-2 rounded-md" data-testid={`table-insight-${table.id}-${insightIndex}`}>
                        â€¢ {insight}
                      </div>
                    ))}
                  </div>
                </div>
              </CardContent>
            </Card>
          ))}
        </div>
      )}

      {/* å·¥ä½œè¡¨è©³æƒ… */}
      <Card>
        <CardHeader>
          <CardTitle>å·¥ä½œè¡¨æ¦‚è¦½</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-3">
            {worksheets.map((sheet) => (
              <div key={sheet.id} className="flex items-center justify-between p-3 bg-muted/20 rounded-lg">
                <div className="space-y-1">
                  <div className="font-medium">{sheet.worksheetName}</div>
                  <div className="text-sm text-muted-foreground">
                    {sheet.rowCount} è¡Œæ•¸æ“šï¼Œ{sheet.headers.length} å€‹æ¬„ä½
                  </div>
                  <div className="text-xs text-muted-foreground">
                    æ¬„ä½: {sheet.headers.join(', ')}
                  </div>
                </div>
                <div className="flex items-center gap-2">
                  <Badge variant={sheet.isEnabled ? 'default' : 'secondary'}>
                    {sheet.isEnabled ? 'å·²å•Ÿç”¨' : 'æœªå•Ÿç”¨'}
                  </Badge>
                </div>
              </div>
            ))}
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
