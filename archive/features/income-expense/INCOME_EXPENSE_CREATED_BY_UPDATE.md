# 收支記錄表 - 填表人欄位可編輯更新

**日期**: 2025-10-16
**狀態**: ✅ 完成

---

## 🎯 更新目標

將「填表人」從只讀欄位改為可編輯下拉選單，並整合到人員資訊區塊

---

## ✅ 完成的修改

### 1. 欄位佈局調整

**變更前** (2 欄佈局)：
```
人員資訊 (grid-cols-2)
├─ 📞 電訪人員
└─ 🎯 諮詢人員

系統資訊 (只讀)
├─ ✍️ 填表人
├─ 🕐 建立時間
└─ 🕑 最後更新
```

**變更後** (3 欄佈局)：
```
人員資訊 (grid-cols-3) - 可編輯
├─ 📞 電訪人員
├─ 🎯 諮詢人員
└─ ✍️ 填表人        ← 新增到這裡，可編輯

時間資訊 (grid-cols-2) - 只讀
├─ 🕐 建立時間
└─ 🕑 最後更新
```

---

### 2. 填表人欄位改為可編輯

**組件類型**：從 `<span>` 改為 `<Select>`

**實作邏輯**：
```tsx
<Select
  value={row.created_by || "none"}
  onValueChange={(value) => handleUpdateRow(index, 'created_by', value === "none" ? "" : value)}
>
  <SelectTrigger className="h-8">
    <SelectValue placeholder="選擇填表人" />
  </SelectTrigger>
  <SelectContent>
    <SelectItem value="none">系統</SelectItem>
    {teachers.map((teacher) => (
      <SelectItem key={teacher.id} value={teacher.id}>
        {teacher.name}
      </SelectItem>
    ))}
  </SelectContent>
</Select>
```

**資料來源**：
- 從 `/api/teachers` 載入所有 users（teacher 角色）
- 預設選項：「系統」（對應空值）

---

### 3. 資料結構更新

**EditableRow 介面**：
```typescript
interface EditableRow {
  // ... 其他欄位
  created_by?: string;          // 填表人 ID（可編輯）✨ 新增
  created_by_name?: string;     // 填表人姓名（顯示用）
  created_at?: string;
  updated_at?: string;
}
```

**資料載入**：
```typescript
created_by: record.created_by,           // ✨ 新增
created_by_name: record.created_by_name,
```

**儲存 Payload**：
```typescript
const payload = {
  // ... 其他欄位
  created_by: row.created_by || null,  // ✨ 新增
};
```

---

## 📊 最終詳細資訊佈局

```
┌────────────── 詳細資訊 ──────────────┐
│                                       │
│  業務資訊 (3 欄)                      │
│  [付款方式]  [課程編號]  [課程類型▼] │
│                                       │
│  人員資訊 (3 欄) - 可編輯             │
│  [電訪人員▼]  [諮詢人員▼]  [填表人▼] │
│                                       │
│  ───────────────────────────────────  │
│  時間資訊 (2 欄) - 只讀               │
│  🕐 建立時間：2025/10/16 16:17       │
│  🕑 最後更新：2025/10/16 16:17       │
│                                       │
│  💱 匯率：1 USD = 30.58 TWD          │
└───────────────────────────────────────┘
```

---

## 🔄 前後對比

| 項目 | 修改前 | 修改後 |
|------|--------|--------|
| 填表人組件 | `<span>` 只讀 | `<Select>` 可編輯 |
| 人員資訊欄位數 | 2 欄 | 3 欄 |
| 系統資訊欄位數 | 3 欄 | 0 欄（整合到其他區塊） |
| 時間資訊欄位數 | 0 欄（在系統資訊中） | 2 欄（獨立區塊） |
| 填表人預設值 | "系統" 文字 | "系統" 選項（value="none"） |

---

## 🎨 視覺設計

**欄位間距**：
- 業務資訊：`grid-cols-3 gap-4`
- 人員資訊：`grid-cols-3 gap-4`
- 時間資訊：`grid-cols-2 gap-4 pt-3 border-t`

**輸入框高度**：
- 詳細資訊欄位：`h-8`（統一小尺寸）
- 主要表格欄位：`h-9`（標準尺寸）

---

## 🧪 測試項目

### **功能測試**
- [ ] 填表人下拉選單顯示所有 users
- [ ] 選擇「系統」時正確儲存空值
- [ ] 選擇用戶後正確儲存 user ID
- [ ] 儲存後重新載入，填表人正確顯示
- [ ] 時間資訊仍保持只讀

### **整合測試**
- [ ] 填表人與電訪人員/諮詢人員互不干擾
- [ ] 新增記錄時可選擇填表人
- [ ] 編輯記錄時可修改填表人

---

## 📂 修改的檔案

**前端**：
- `client/src/pages/reports/income-expense-manager.tsx`
  - EditableRow 介面新增 `created_by` 欄位
  - 人員資訊區塊從 2 欄改為 3 欄
  - 填表人改為 Select 組件
  - 時間資訊獨立為 2 欄區塊
  - 資料載入邏輯新增 `created_by`
  - 儲存 payload 新增 `created_by`

**後端**：
- ✅ 無需修改（已支援 `created_by` 欄位）

---

## 💡 設計決策

### **為什麼整合到人員資訊？**
1. **語意相關**：填表人與電訪人員、諮詢人員同為人員角色
2. **操作一致**：三個欄位都使用相同的 Select 下拉選單
3. **視覺平衡**：3 欄佈局更對稱美觀

### **為什麼時間資訊獨立？**
1. **功能區分**：時間是只讀的系統資訊，與可編輯人員區隔
2. **視覺層次**：用 `border-t` 分隔，清楚標示不可編輯

### **為什麼保留「系統」選項？**
1. **向後相容**：既有記錄可能沒有 `created_by`
2. **靈活性**：自動匯入的記錄可標記為「系統」
3. **明確性**：比空白更清楚表達「無指定填表人」

---

## 🚀 後續建議

### **可選增強**
1. **預設填表人**：新增記錄時自動設為當前登入用戶
2. **權限控制**：僅管理員可修改填表人
3. **變更記錄**：記錄填表人修改歷史

### **不建議修改**
- ❌ 不要將建立/更新時間改為可編輯（資料完整性）
- ❌ 不要隱藏時間資訊（追溯需求）

---

**完成時間**: 2025-10-16 下午
**修改行數**: ~50 行
**測試狀態**: ⏳ 待瀏覽器驗證
