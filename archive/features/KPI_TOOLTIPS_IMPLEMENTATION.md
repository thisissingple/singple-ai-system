# KPI 定義 Tooltip 與對話框實作完成

## ✅ 已完成功能

### 1. **Hover Tooltip（懸停提示）**
- 滑鼠移到任何 KPI 卡片上，會顯示簡短定義
- 延遲 300ms 後顯示，避免誤觸
- 包含提示：點擊 ℹ️ 查看完整定義

### 2. **完整定義對話框**
- 每個 KPI 卡片右上角有 ℹ️ 圖示按鈕
- 點擊後彈出對話框，顯示：
  - KPI 標題 + 當前值
  - 簡短描述
  - 計算公式（藍色框）
  - 詳細說明（Markdown 格式）
  - 數據來源說明

### 3. **更新的 KPI 定義**

#### **轉換率** (46.7%)
- **簡短**：已轉高學生數 ÷ 已上完課學生數
- **公式**：`(已轉高學生數 / 已上完課學生數) × 100`
- **意義**：衡量體驗課的轉換效果

#### **平均轉換時間** (23.0 天)
- **簡短**：從體驗課到成交的平均天數
- **公式**：`總轉換天數 / 有效配對數`
- **意義**：了解銷售週期，優化跟進策略

#### **體驗課完成率** (30.9%)
- **簡短**：已上完課學生數 ÷ 所有體驗課學員 ✅ **已更新**
- **公式**：`(已上完課學生數 / 所有體驗課學員) × 100`
- **意義**：反映學員參與度

#### **待跟進學生** (66 人)
- **簡短**：體驗中 + 未開始的學生數
- **公式**：`COUNT(狀態 = "體驗中" OR "未開始")`
- **意義**：需要主動跟進的學生

#### **已轉高實收金額** (NT$ 1,592,002) ✅ **已修正**
- **簡短**：已轉高學員的高階方案總收益
- **公式**：`SUM(已轉高學員的高階方案實收金額)`
- **意義**：體驗課帶來的實際收益
- **修正**：現在正確計算高階一對一方案金額

#### **總學生數** (97 人)
- **簡短**：購買體驗課的唯一學生數
- **公式**：`COUNT(DISTINCT student_email)`
- **意義**：體驗課的總觸及人數

---

## 📁 新增/修改檔案

### 新增檔案

1. **`client/src/config/kpi-definitions.ts`** 🆕
   - KPI 定義常數
   - 包含所有 6 個 KPI 的完整定義
   - 簡短描述、完整說明、公式、單位

2. **`client/src/components/trial-report/kpi-definition-dialog.tsx`** 🆕
   - 定義對話框組件
   - 使用 React Markdown 渲染說明
   - 響應式設計，最大高度 80vh

### 修改檔案

3. **`client/src/components/trial-report/kpi-overview.tsx`** 🔄
   - 加入 Tooltip 支援
   - 加入 ℹ️ 圖示按鈕
   - 管理對話框狀態
   - 更新「體驗課完成率」的 subtitle

4. **`server/services/kpi-calculator.ts`** 🔄
   - 修正收益計算：加入頂層 `plan` 和 `actual_amount` 欄位查找
   - 新增 `revenueWarnings` 變數定義

5. **`server/services/reporting/direct-sql-repository.ts`** 🔄
   - 修正 `normalizeDealRow`：將 `plan` 和 `actual_amount` 提升到頂層
   - 確保 KPI 計算器可以正確讀取方案名稱和金額

---

## 🎯 使用方式

### 查看簡短定義（Hover）
1. 移動滑鼠到任何 KPI 卡片上
2. 等待 0.3 秒
3. 會顯示簡短定義的 Tooltip

### 查看完整定義（點擊 ℹ️）
1. 點擊 KPI 卡片右上角的 ℹ️ 圖示
2. 彈出對話框顯示完整定義
3. 可以捲動查看詳細說明
4. 點擊對話框外或按 ESC 關閉

---

## 🔧 技術細節

### 依賴項
- ✅ `@radix-ui/react-tooltip` (已安裝)
- ✅ `react-markdown` v10.1.0 (已安裝)
- ✅ Shadcn UI Dialog, Tooltip 組件

### 組件架構
```
KPIOverview (管理狀態)
  ├── KPICard × 6 (每個 KPI)
  │     ├── TooltipProvider
  │     │     └── Tooltip (hover 顯示)
  │     └── Info 按鈕 (點擊顯示對話框)
  └── KPIDefinitionDialog (彈出對話框)
```

### 數據流
```
kpi-definitions.ts (定義)
       ↓
getKPIDefinition() (取得定義)
       ↓
KPICard (Tooltip) + KPIDefinitionDialog (對話框)
```

---

## ✨ 特色

1. **雙層資訊架構**：
   - 第一層：Hover 顯示簡短定義（快速查看）
   - 第二層：點擊顯示完整定義（深入了解）

2. **視覺化設計**：
   - 計算公式用藍色框凸顯
   - Markdown 支援粗體、列表等格式
   - 響應式佈局

3. **使用者體驗**：
   - Tooltip 延遲避免誤觸
   - 對話框可捲動（長內容）
   - 點擊外部或 ESC 關閉

4. **可維護性**：
   - 定義集中管理在 `kpi-definitions.ts`
   - 易於新增或修改 KPI 定義
   - TypeScript 型別安全

---

## 📊 修正的問題

### 問題 1: 已轉高總收益顯示 NT$ 0 ✅
**根本原因**：
- `normalizeDealRow` 沒有將 `plan` 和 `actual_amount` 放到頂層
- KPI 計算器只查 `deal.data`，找不到方案名稱

**解決方案**：
- 在 `direct-sql-repository.ts` 中提升欄位到頂層
- 在 `kpi-calculator.ts` 中優先查找頂層欄位

**結果**：NT$ 0 → **NT$ 1,592,002** ✅

### 問題 2: 體驗課完成率定義不清 ✅
**原本**：「預約學生的實際上課率」（模糊）
**更新為**：「已上完課 / 所有體驗課學員」（清楚明確）

---

## 🚀 下一步建議

1. **測試所有 KPI 定義對話框**
   - 確認每個 KPI 的定義正確顯示
   - 測試 Tooltip 和對話框互動

2. **可選擇的增強功能**：
   - 加入計算過程的詳細步驟
   - 加入歷史趨勢圖
   - 加入匯出定義為 PDF

3. **用戶反饋**：
   - 收集使用者對定義清晰度的反饋
   - 根據反饋調整定義內容

---

**實作完成時間**：2025-10-13
**狀態**：✅ 完成並可測試
